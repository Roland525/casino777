<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lucky Box Casino</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- AUTH -->
  <div id="authPanel" class="card auth">
    <h1 class="logo">Lucky Box Casino</h1>
    <p class="note">–í—Ö–æ–¥ –ø–æ –Ω–∏–∫—É. –ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ (MockAPI).</p>
    <input id="nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="24" />
    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg" class="msg">‚Äî</p>
  </div>

  <!-- CASINO -->
  <div id="casino" class="container hidden">
    <header class="topbar">
      <div class="brand">üé≤ Lucky Box</div>
      <div class="pill">
        –ü—Ä–∏–≤–µ—Ç, <b id="userDisplay">‚Äî</b>! –ë–∞–ª–∞–Ω—Å: <b id="balance">0</b> üí∞
      </div>
      <button class="btn danger" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="tab-slots">üé∞ –°–ª–æ—Ç—ã</button>
      <button class="tab-btn" data-tab="tab-bj">üÉè –ë–ª—ç–∫–¥–∂–µ–∫</button>
      <button class="tab-btn" data-tab="tab-roulette">üé° –†—É–ª–µ—Ç–∫–∞</button>
      <button class="tab-btn" data-tab="tab-mines">üí£ –ú–∏–Ω—ã</button>
    </nav>

    <!-- –°–õ–û–¢–´ -->
    <section id="tab-slots" class="card">
      <h2>–°–ª–æ—Ç—ã</h2>
      <div class="slot-wrap">
        <div class="reels" id="reels"></div>
        <div class="controls">
          <button class="btn" id="spin">–ö—Ä—É—Ç–∏—Ç—å (-100)</button>
          <p id="slotMsg" class="msg">‚Äî</p>
        </div>
      </div>
    </section>

    <!-- –ë–õ–≠–ö–î–ñ–ï–ö -->
    <section id="tab-bj" class="card hidden">
      <h2>–ë–ª—ç–∫–¥–∂–µ–∫</h2>
      <div class="table">
        <div class="msg faint">–¶–µ–ª—å: –Ω–∞–±—Ä–∞—Ç—å –±–ª–∏–∂–µ –∫ 21, —á–µ–º –¥–∏–ª–µ—Ä</div>
        <div class="hands">
          <div>
            <h3>–ò–≥—Ä–æ–∫</h3>
            <div class="hand" id="playerHand"></div>
          </div>
          <div>
            <h3>–î–∏–ª–µ—Ä</h3>
            <div class="hand" id="dealerHand"></div>
          </div>
        </div>
        <div class="bj-ctrls">
          <button class="btn" id="hit">–í–∑—è—Ç—å</button>
          <button class="btn" id="stand">–•–≤–∞—Ç–∏—Ç (-200)</button>
          <button class="btn ghost" id="bjReset">–°–±—Ä–æ—Å</button>
        </div>
        <div id="bjMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –†–£–õ–ï–¢–ö–ê -->
    <section id="tab-roulette" class="card hidden">
      <h2>–†—É–ª–µ—Ç–∫–∞</h2>
      <div class="roulette">
        <div class="wheel-area">
          <div class="pointer" id="pointer"></div>
          <div class="wheel" id="wheel"><div class="face"></div></div>
        </div>
        <div class="row">
          <label class="pill">–°—Ç–∞–≤–∫–∞ –Ω–∞ —Ü–≤–µ—Ç:
            <select id="pickColor">
              <option value="red">–∫—Ä–∞—Å–Ω–æ–µ</option>
              <option value="black">—á—ë—Ä–Ω–æ–µ</option>
              <option value="green">–∑–µ—Ä–æ</option>
            </select>
          </label>
          <button class="btn" id="spinRoulette">–í—Ä–∞—â–∞—Ç—å (-150)</button>
        </div>
        <div id="roulMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –ú–ò–ù–´ -->
    <section id="tab-mines" class="card hidden">
      <h2>–ú–∏–Ω—ã</h2>
      <div class="mines-wrap">
        <div class="row wrap">
          <label class="pill">–°—Ç–∞–≤–∫–∞:
            <input id="minesBet" type="number" min="1" value="100" />
          </label>
          <label class="pill">–ú–∏–Ω:
            <input id="minesCount" type="number" min="1" max="24" value="5" />
          </label>
          <button class="btn" id="minesStart">–ù–∞—á–∞—Ç—å</button>
          <button class="btn" id="minesCashout" disabled>–ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à</button>
        </div>
        <div class="mines-grid" id="minesGrid"></div>
        <div id="minesMsg" class="msg">‚Äî</div>
      </div>
    </section>
  </div>

  <!-- JS -->
  <script>
    "use strict";

    /************* MOCKAPI CONFIG *************/
    /* –ó–ê–ú–ï–ù–ò–¢–ï –°–°–´–õ–ö–£ –ù–ò–ñ–ï –Ω–∞ –≤–∞—à —Ä–µ—Å—É—Ä—Å users, –Ω–∞–ø—Ä–∏–º–µ—Ä:
       https://69147b693746c71fe0486c2c.mockapi.io/users
    */
    var API_URL = "https://69147b693746c71fe0486c2c.mockapi.io/users";

    async function apiFindByName(name){
      var res = await fetch(API_URL + "?name=" + encodeURIComponent(name));
      return res.json(); // –º–∞—Å—Å–∏–≤
    }
    async function apiCreate(name, balance){
      var res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name, balance: balance })
      });
      return res.json();
    }
    async function apiUpdate(id, payload){
      await fetch(API_URL + "/" + encodeURIComponent(id), {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }

    /************* AUTH *************/
    var $auth = document.getElementById("authPanel");
    var $casino = document.getElementById("casino");
    var $authMsg = document.getElementById("authMsg");
    var $nick = document.getElementById("nickname");
    var $user = document.getElementById("userDisplay");
    var $bal = document.getElementById("balance");

    var currentUser = null; // {id,name,balance}

    function updateBalanceUI(){
      $bal.textContent = currentUser.balance;
      $bal.parentElement.classList.add("shine");
      setTimeout(function(){ $bal.parentElement.classList.remove("shine"); }, 600);
    }
    function openCasino(){
      $auth.classList.add("hidden");
      $casino.classList.remove("hidden");
      document.querySelector('[data-tab="tab-slots"]').click();
      $user.textContent = currentUser.name;
      updateBalanceUI();
    }

    document.getElementById("loginBtn").addEventListener("click", async function(){
      var nick = $nick.value.trim();
      if(!nick){ $authMsg.textContent="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫"; return; }
      $authMsg.textContent="–ó–∞–≥—Ä—É–∑–∫–∞...";
      try{
        var found = await apiFindByName(nick);
        if(found.length){
          currentUser = { id: found[0].id, name: found[0].name, balance: found[0].balance };
          $authMsg.textContent = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!";
        }else{
          var u = await apiCreate(nick, 1000);
          currentUser = { id: u.id, name: u.name, balance: u.balance };
          $authMsg.textContent = "–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç";
        }
        openCasino();
      }catch(e){
        console.error(e);
        $authMsg.textContent = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å MockAPI";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", function(){
      location.reload();
    });

    async function saveBalance(){
      if(!currentUser) return;
      try{
        await apiUpdate(currentUser.id, { name: currentUser.name, balance: currentUser.balance });
      }catch(e){ console.warn("Save failed", e); }
    }

    /************* TABS *************/
    document.querySelectorAll(".tab-btn").forEach(function(btn){
      btn.addEventListener("click", function(){
        document.querySelectorAll(".tab-btn").forEach(function(b){ b.classList.remove("active"); });
        btn.classList.add("active");
        document.querySelectorAll("section.card").forEach(function(s){ s.classList.add("hidden"); });
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
      });
    });

    /************* SLOTS *************/
    var symbols = ["üçí","üçã","‚≠ê","üîî","üçÄ","7Ô∏è‚É£","üíé","üçâ"];
    var $reels = document.getElementById("reels");
    var reelEls = [];

    function makeStrip(result){
      var strip = document.createElement("div");
      strip.className = "strip";
      strip.style.top = "-360px";
      for (var i=0;i<3;i++){
        var c=document.createElement("div");
        c.className="cell";
        c.textContent=result[i];
        strip.appendChild(c);
      }
      for (var j=0;j<3;j++){
        var c2=document.createElement("div");
        c2.className="cell";
        c2.textContent=symbols[Math.floor(Math.random()*symbols.length)];
        strip.appendChild(c2);
      }
      return strip;
    }
    function initSlotsUI(){
      $reels.innerHTML="";
      reelEls=[];
      for (var i=0;i<5;i++){
        var reel=document.createElement("div");
        reel.className="reel";
        var res=[0,1,2].map(function(){ return symbols[Math.floor(Math.random()*symbols.length)]; });
        reel.appendChild(makeStrip(res));
        $reels.appendChild(reel);
        reelEls.push(reel);
      }
    }
    initSlotsUI();

    var slotMsg = document.getElementById("slotMsg");
    document.getElementById("spin").addEventListener("click", async function(){
      var cost=100;
      if(currentUser.balance<cost){ slotMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }
      currentUser.balance-=cost; updateBalanceUI(); await saveBalance();

      var reelsWrap=document.querySelector(".reels");
      reelsWrap.classList.add("shake");
      setTimeout(function(){ reelsWrap.classList.remove("shake"); },900);
      slotMsg.textContent="–ö—Ä—É—Ç–∏–º‚Ä¶";

      var strips=[];
      reelEls.forEach(function(reel){
        var result=[0,1,2].map(function(){ return symbols[Math.floor(Math.random()*symbols.length)]; });
        var st=makeStrip(result); reel.innerHTML=""; reel.appendChild(st); strips.push(st);
      });
      strips.forEach(function(st,i){ setTimeout(function(){ st.parentElement.classList.add("spinning"); }, i*120); });

      setTimeout(async function(){
        reelEls.forEach(function(reel){
          var st=reel.querySelector(".strip");
          st.style.top="0px";
          st.style.transform="none";
          reel.classList.remove("spinning");
        });
        var win=0; var r=Math.random();
        if (r<0.06) win=800; else if (r<0.18) win=200;
        if (win){ currentUser.balance+=win; slotMsg.textContent="üéâ –í—ã–∏–≥—Ä—ã—à +"+win; slotMsg.classList.add("glow"); setTimeout(function(){ slotMsg.classList.remove("glow"); },800); }
        else { slotMsg.textContent="–ü—Ä–æ–∏–≥—Ä—ã—à"; }
        updateBalanceUI(); await saveBalance();
      }, 1800);
    });

    /************* BLACKJACK *************/
    var SUITS=["‚ô†","‚ô•","‚ô¶","‚ô£"]; var RANKS=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    var $pHand=document.getElementById("playerHand");
    var $dHand=document.getElementById("dealerHand");
    var $bjMsg=document.getElementById("bjMsg");
    var deck=[], player=[], dealer=[];

    function freshDeck(){ var d=[]; for(var s of SUITS){ for(var r of RANKS){ d.push(r+s); } } return d; }
    function drawCard(){ var i=Math.floor(Math.random()*deck.length); return deck.splice(i,1)[0]; }
    function val(card){ var r=card.slice(0,-1); if(r==="J"||r==="Q"||r==="K") return 10; if(r==="A") return 11; return Number(r); }
    function total(arr){ var t=arr.reduce(function(a,c){return a+val(c);},0); var ac=arr.filter(function(c){return c.startsWith("A");}).length; while(t>21&&ac){t-=10;ac--;} return t; }
    function cardEl(card){
      var r=card.slice(0,-1), s=card.slice(-1);
      var d=document.createElement("div");
      d.className="card-face"+((s==="‚ô•"||s==="‚ô¶")?" red":"");
      d.innerHTML='<div class="rank">'+r+'</div><div class="suit">'+s+'</div>';
      d.style.animation="deal .28s ease";
      return d;
    }
    function renderBJ(){ $pHand.innerHTML=""; $dHand.innerHTML=""; player.forEach(function(c){ $pHand.appendChild(cardEl(c)); }); dealer.forEach(function(c){ $dHand.appendChild(cardEl(c)); }); }
    function startBJ(){ deck=freshDeck(); player=[drawCard(),drawCard()]; dealer=[drawCard()]; $bjMsg.textContent="‚Äî"; $bjMsg.style.color=""; renderBJ(); }
    startBJ();

    document.getElementById("hit").addEventListener("click", function(){
      player.push(drawCard()); renderBJ();
      if(total(player)>21){ $bjMsg.textContent="–ü–µ—Ä–µ–±–æ—Ä!"; $bjMsg.style.color="var(--lose)"; }
    });
    document.getElementById("stand").addEventListener("click", async function(){
      var cost=200; if(currentUser.balance<cost){ $bjMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; $bjMsg.style.color="var(--lose)"; return; }
      currentUser.balance-=cost; updateBalanceUI(); await saveBalance();
      while(total(dealer)<17){ dealer.push(drawCard()); } renderBJ();
      var pt=total(player), dt=total(dealer); var rig=Math.random();
      if((dt>21||pt>dt)&&rig<0.5){ $bjMsg.textContent="–ü–æ–±–µ–¥–∞! +400"; $bjMsg.style.color="var(--win)"; currentUser.balance+=400; }
      else if(pt===dt){ $bjMsg.textContent="–ù–∏—á—å—è (–≤–æ–∑–≤—Ä–∞—Ç 200)"; $bjMsg.style.color="var(--warn)"; currentUser.balance+=200; }
      else { $bjMsg.textContent="–ü—Ä–æ–∏–≥—Ä—ã—à"; $bjMsg.style.color="var(--lose)"; }
      updateBalanceUI(); await saveBalance();
    });
    document.getElementById("bjReset").addEventListener("click", startBJ);

    /************* ROULETTE *************/
    var order=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
    var colors={0:"green"}; var reds=new Set([32,19,21,25,34,27,36,30,23,5,16,1,14,9,18,7,12,3]); order.forEach(function(n){ if(n!==0){ colors[n]=reds.has(n)?"red":"black"; } });
    var seg=360/order.length; var $wheel=document.getElementById("wheel"); var $roulMsg=document.getElementById("roulMsg"); var $pickColor=document.getElementById("pickColor"); var $pointer=document.getElementById("pointer");

    function spinTo(idx){
      var target=360-(idx*seg+seg/2);
      var turns=6+Math.floor(Math.random()*4);
      var rot=turns*360+target;
      $wheel.style.transition="transform 3.2s cubic-bezier(.18,.75,.2,1)";
      $wheel.style.transform="rotate("+rot+"deg)";
    }
    document.getElementById("spinRoulette").addEventListener("click", async function(){
      var cost=150; if(currentUser.balance<cost){ $roulMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; $roulMsg.style.color="var(--lose)"; return; }
      currentUser.balance-=cost; updateBalanceUI(); await saveBalance();
      $roulMsg.textContent="–í—Ä–∞—â–µ–Ω–∏–µ‚Ä¶"; $roulMsg.style.color="#a9b6df";
      var winIdx=Math.floor(Math.random()*order.length); spinTo(winIdx);
      var winNum=order[winIdx]; var winCol=colors[winNum];
      setTimeout(async function(){
        $pointer.classList.add("pointer-tick"); setTimeout(function(){ $pointer.classList.remove("pointer-tick"); }, 500);
        var win=0; if($pickColor.value===winCol){ win=300; }
        if(win){ currentUser.balance+=win; $roulMsg.textContent="–í—ã–ø–∞–ª–æ "+winNum+" ("+winCol+"). –í—ã–∏–≥—Ä—ã—à +"+win; $roulMsg.style.color="var(--win)"; }
        else { $roulMsg.textContent="–í—ã–ø–∞–ª–æ "+winNum+" ("+winCol+"). –ü—Ä–æ–∏–≥—Ä—ã—à."; $roulMsg.style.color="var(--lose)"; }
        updateBalanceUI(); await saveBalance();
      }, 3300);
    });

    /************* MINES *************/
    var gridSize=5; var totalCells=gridSize*gridSize;
    var $minesGrid=document.getElementById("minesGrid"); var $minesMsg=document.getElementById("minesMsg");
    var $minesBet=document.getElementById("minesBet"); var $minesCount=document.getElementById("minesCount");
    var $minesStart=document.getElementById("minesStart"); var $minesCash=document.getElementById("minesCashout");

    var minesActive=false, revealed=0, minesSet=new Set(), clicked=new Set(), stake=0, mines=0, mult=1;

    function resetMinesUI(){
      $minesGrid.innerHTML="";
      for(var i=0;i<totalCells;i++){
        var cell=document.createElement("button");
        cell.className="mine-cell";
        cell.dataset.idx=String(i);
        cell.textContent="?";
        cell.disabled=true;
        (function(idx,el){ el.addEventListener("click", function(){ onMine(idx, el); }); })(i, cell);
        $minesGrid.appendChild(cell);
      }
      $minesMsg.textContent="‚Äî"; $minesCash.disabled=true;
    }
    resetMinesUI();

    function randomMines(count){ var set=new Set(); while(set.size<count){ set.add(Math.floor(Math.random()*totalCells)); } return set; }
    function stepMultiplier(){
      var safeLeft=(totalCells-mines)-revealed; var cellsLeft=totalCells-revealed;
      var p=safeLeft/cellsLeft; var risk=1+(mines/totalCells)*3.5;
      var m=Math.pow(1/Math.max(0.05,p), risk)*0.97; return m;
    }
    function payout(){ var total=Math.floor(stake*mult); return { total: total, profit: Math.max(0,total-stake) }; }

    async function startMines(){
      stake=Math.max(1,parseInt($minesBet.value||"0",10));
      mines=Math.max(1,Math.min(24,parseInt($minesCount.value||"0",10)));
      if(currentUser.balance<stake){ $minesMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; $minesMsg.style.color="var(--lose)"; return; }
      currentUser.balance-=stake; updateBalanceUI(); await saveBalance();
      minesSet=randomMines(mines); minesActive=true; revealed=0; clicked.clear(); mult=1;
      Array.prototype.forEach.call($minesGrid.children, function(c){ c.disabled=false; c.classList.remove("revealed","boom"); c.textContent="?"; });
      $minesMsg.textContent="–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –û—Ç–∫—Ä—ã–≤–∞–π –∫–ª–µ—Ç–∫–∏. √ó —Ä–∞—Å—Ç—ë—Ç –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ."; $minesMsg.style.color="#a9b6df"; $minesCash.disabled=true;
    }
    function onMine(idx, el){
      if(!minesActive || clicked.has(idx)) return; clicked.add(idx);
      if(minesSet.has(idx)){
        el.classList.add("boom"); el.textContent="üí£";
        revealMines(); $minesMsg.textContent="üí• –ú–∏–Ω–∞! –°—Ç–∞–≤–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞."; $minesMsg.style.color="var(--lose)";
        minesActive=false; $minesCash.disabled=true; disableGrid(); return;
      }
      revealed++; mult*=stepMultiplier(); el.classList.add("revealed"); el.textContent="üíé";
      var pr=payout(); $minesMsg.textContent="–ë–µ–∑–æ–ø–∞—Å–Ω–æ! √ó"+mult.toFixed(3)+" | –ü—Ä–æ—Ñ–∏—Ç —Å–µ–π—á–∞—Å: +"+pr.profit; $minesMsg.style.color="var(--win)"; $minesCash.disabled=false;
      if(revealed >= (totalCells-mines)){ cashout(true); }
    }
    function revealMines(){ Array.prototype.forEach.call($minesGrid.children, function(c,i){ if(minesSet.has(i)){ c.classList.add("boom"); c.textContent="üí£"; } }); }
    function disableGrid(){ Array.prototype.forEach.call($minesGrid.children, function(c){ c.disabled=true; }); }
    async function cashout(auto){
      if(!minesActive || revealed===0) return;
      var pr=payout(); currentUser.balance+=pr.profit; updateBalanceUI(); await saveBalance();
      $minesMsg.textContent=(auto?"–í—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã! ":"")+"–ó–∞–±—Ä–∞–ª +"+pr.profit+". –ò—Ç–æ–≥: "+pr.total+"."; $minesMsg.style.color="var(--win)";
      minesActive=false; $minesCash.disabled=true; disableGrid();
    }
    $minesStart.addEventListener("click", startMines);
    $minesCash.addEventListener("click", function(){ cashout(false); });
  </script>
</body>
</html>
