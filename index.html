<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Lucky Box Casino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- AUTH -->
  <div id="authPanel" class="card auth">
    <h1 class="logo">Lucky Box Casino</h1>
    <p class="note">–í—Ö–æ–¥ –ø–æ –Ω–∏–∫—É. –ê–∫–∫–∞—É–Ω—Ç –∏ –±–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</p>
    <input id="nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="24" />
    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg" class="msg">‚Äî</p>
  </div>

  <!-- CASINO -->
  <div id="casino" class="container hidden">
    <header class="topbar">
      <div class="brand">üé≤ Lucky Box</div>
      <div class="pill">
        –ü—Ä–∏–≤–µ—Ç, <b id="userDisplay">‚Äî</b>! –ë–∞–ª–∞–Ω—Å: <b id="balance">0</b> üí∞
      </div>
      <button class="btn danger" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="tab-slots">üé∞ –°–ª–æ—Ç—ã</button>
      <button class="tab-btn" data-tab="tab-bj">üÉè –ë–ª—ç–∫–¥–∂–µ–∫</button>
      <button class="tab-btn" data-tab="tab-roulette">üé° –†—É–ª–µ—Ç–∫–∞</button>
      <button class="tab-btn" data-tab="tab-mines">üí£ –ú–∏–Ω—ã</button>
    </nav>

    <!-- –°–õ–û–¢–´ -->
    <section id="tab-slots" class="card">
      <h2>–°–ª–æ—Ç—ã</h2>
      <div class="slot-wrap">
        <div class="reels" id="reels"></div>
        <div class="controls">
          <button class="btn" id="spin">–ö—Ä—É—Ç–∏—Ç—å (-100)</button>
          <p id="slotMsg" class="msg">‚Äî</p>
        </div>
      </div>
    </section>

    <!-- –ë–õ–≠–ö–î–ñ–ï–ö -->
    <section id="tab-bj" class="card hidden">
      <h2>–ë–ª—ç–∫–¥–∂–µ–∫</h2>
      <div class="table">
        <div class="msg faint">–¶–µ–ª—å: –Ω–∞–±—Ä–∞—Ç—å –±–ª–∏–∂–µ –∫ 21, —á–µ–º –¥–∏–ª–µ—Ä</div>
        <div class="hands">
          <div>
            <h3>–ò–≥—Ä–æ–∫</h3>
            <div class="hand" id="playerHand"></div>
          </div>
          <div>
            <h3>–î–∏–ª–µ—Ä</h3>
            <div class="hand" id="dealerHand"></div>
          </div>
        </div>
        <div class="bj-ctrls">
          <button class="btn" id="hit">–í–∑—è—Ç—å</button>
          <button class="btn" id="stand">–•–≤–∞—Ç–∏—Ç (-200)</button>
          <button class="btn ghost" id="bjReset">–°–±—Ä–æ—Å</button>
        </div>
        <div id="bjMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –†–£–õ–ï–¢–ö–ê -->
    <section id="tab-roulette" class="card hidden">
      <h2>–†—É–ª–µ—Ç–∫–∞</h2>
      <div class="roulette">
        <div class="wheel-area">
          <div class="pointer" id="pointer"></div>
          <div class="wheel" id="wheel"><div class="face"></div></div>
        </div>
        <div class="row">
          <label class="pill">–°—Ç–∞–≤–∫–∞ –Ω–∞ —Ü–≤–µ—Ç:
            <select id="pickColor">
              <option value="red">–∫—Ä–∞—Å–Ω–æ–µ</option>
              <option value="black">—á—ë—Ä–Ω–æ–µ</option>
              <option value="green">–∑–µ—Ä–æ</option>
            </select>
          </label>
          <button class="btn" id="spinRoulette">–í—Ä–∞—â–∞—Ç—å (-150)</button>
        </div>
        <div id="roulMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –ú–ò–ù–´ -->
    <section id="tab-mines" class="card hidden">
      <h2>–ú–∏–Ω—ã</h2>
      <div class="mines-wrap">
        <div class="row wrap">
          <label class="pill">–°—Ç–∞–≤–∫–∞:
            <input id="minesBet" type="number" min="1" value="100" />
          </label>
          <label class="pill">–ú–∏–Ω:
            <input id="minesCount" type="number" min="1" max="24" value="5" />
          </label>
          <button class="btn" id="minesStart">–ù–∞—á–∞—Ç—å</button>
          <button class="btn" id="minesCashout" disabled>–ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à</button>
        </div>
        <div class="mines-grid" id="minesGrid"></div>
        <div id="minesMsg" class="msg">‚Äî</div>
      </div>
    </section>
  </div>

  <script>
    /***********************
     * –ö–õ–ò–ï–ù–¢ ‚Üî –°–ï–†–í–ï–† API *
     ***********************/
    async function apiLogin(name) {
      const res = await fetch(\`/login?name=\${encodeURIComponent(name)}\`);
      return res.json();
    }
    async function apiSave(name, balance) {
      await fetch(\`/save?name=\${encodeURIComponent(name)}&balance=\${encodeURIComponent(balance)}\`);
    }

    /***********************
     * AUTH
     ***********************/
    const $auth = document.getElementById('authPanel');
    const $casino = document.getElementById('casino');
    const $authMsg = document.getElementById('authMsg');
    const $nick = document.getElementById('nickname');
    const $user = document.getElementById('userDisplay');
    const $bal = document.getElementById('balance');

    let currentUser = null; // { name, balance }

    function openCasino() {
      $auth.classList.add('hidden');
      $casino.classList.remove('hidden');
      document.querySelector('[data-tab="tab-slots"]').click(); // –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ—Ç—ã
      $user.textContent = currentUser.name;
      updateBalanceUI();
    }
    function updateBalanceUI() {
      $bal.textContent = currentUser.balance;
      $bal.parentElement.classList.add('shine');
      setTimeout(()=> $bal.parentElement.classList.remove('shine'), 600);
    }

    document.getElementById('loginBtn').addEventListener('click', async () => {
      const nick = $nick.value.trim();
      if (!nick) { $authMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫'; return; }
      $authMsg.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try {
        const u = await apiLogin(nick);
        if (u.error) { $authMsg.textContent = u.error; return; }
        currentUser = u;
        $authMsg.textContent = u.justCreated ? '–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç' : '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!';
        openCasino();
      } catch (e) {
        console.error(e);
        $authMsg.textContent = '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await apiSave(currentUser.name, currentUser.balance); } catch(e){}
      location.reload();
    });

    /***********************
     * –í–ö–õ–ê–î–ö–ò
     ***********************/
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('section.card').forEach(s=> s.classList.add('hidden'));
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
      });
    });

    /***********************
     * –°–õ–û–¢–´ (–∞–Ω–∏–º)
     ***********************/
    const symbols = ['üçí','üçã','‚≠ê','üîî','üçÄ','7Ô∏è‚É£','üíé','üçâ'];
    const $reels = document.getElementById('reels');
    const reelEls=[];
    function makeStrip(result){
      const strip=document.createElement('div');
      strip.className='strip';
      strip.style.top='-360px';
      for(let i=0;i<3;i++){ const c=document.createElement('div'); c.className='cell'; c.textContent=result[i]; strip.appendChild(c); }
      for(let i=0;i<3;i++){ const c=document.createElement('div'); c.className='cell'; c.textContent=symbols[Math.random()*symbols.length|0]; strip.appendChild(c); }
      return strip;
    }
    function initSlotsUI(){
      $reels.innerHTML='';
      for(let i=0;i<5;i++){
        const reel=document.createElement('div'); reel.className='reel';
        const res=[0,1,2].map(()=>symbols[Math.random()*symbols.length|0]);
        reel.appendChild(makeStrip(res));
        $reels.appendChild(reel); reelEls.push(reel);
      }
    }
    initSlotsUI();

    document.getElementById('spin').addEventListener('click', async ()=>{
      const cost=100; if(currentUser.balance<cost){ slotMsg.textContent='–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'; return; }
      currentUser.balance-=cost; updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
      const reelsWrap=document.querySelector('.reels'); reelsWrap.classList.add('shake'); setTimeout(()=>reelsWrap.classList.remove('shake'),900);
      slotMsg.textContent='–ö—Ä—É—Ç–∏–º‚Ä¶';
      const strips=[];
      reelEls.forEach((reel)=>{
        const result=[0,1,2].map(()=>symbols[Math.random()*symbols.length|0]);
        const st=makeStrip(result); reel.innerHTML=''; reel.appendChild(st); strips.push(st);
      });
      strips.forEach((st,i)=> setTimeout(()=> st.parentElement.classList.add('spinning'), i*120));
      setTimeout(async ()=>{
        reelEls.forEach(reel=>{ const st=reel.querySelector('.strip'); st.style.top='0px'; st.style.transform='none'; reel.classList.remove('spinning'); });
        let win=0; const r=Math.random(); if(r<0.06) win=800; else if(r<0.18) win=200;
        if(win){ currentUser.balance+=win; slotMsg.textContent=`üéâ –í—ã–∏–≥—Ä—ã—à +${win}`; slotMsg.classList.add('glow'); setTimeout(()=>slotMsg.classList.remove('glow'),800); }
        else { slotMsg.textContent='–ü—Ä–æ–∏–≥—Ä—ã—à'; }
        updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
      }, 1800);
    });

    /***********************
     * –ë–õ–≠–ö–î–ñ–ï–ö (–≤–∏–∑—É–∞–ª)
     ***********************/
    const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£']; const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const $pHand=document.getElementById('playerHand'); const $dHand=document.getElementById('dealerHand'); const $bjMsg=document.getElementById('bjMsg');
    let deck=[], player=[], dealer=[];
    function freshDeck(){ const d=[]; for(const s of SUITS){ for(const r of RANKS){ d.push(r+s);} } return d; }
    function drawCard(){ const i=Math.floor(Math.random()*deck.length); return deck.splice(i,1)[0]; }
    function val(card){ const r=card.slice(0,-1); if(['J','Q','K'].includes(r)) return 10; if(r==='A') return 11; return Number(r); }
    function total(arr){ let t=arr.reduce((a,c)=>a+val(c),0); let ac=arr.filter(c=>c.startsWith('A')).length; while(t>21&&ac){t-=10;ac--} return t; }
    function cardEl(card){
      const r=card.slice(0,-1), s=card.slice(-1);
      const d=document.createElement('div');
      d.className='card-face'+(/‚ô•|‚ô¶/.test(s)?' red':'');
      d.innerHTML = `<div class="rank">${r}</div><div class="suit">${s}</div>`;
      d.style.animation='deal .28s ease';
      return d;
    }
    function renderBJ(){ $pHand.innerHTML=''; $dHand.innerHTML=''; player.forEach(c=>$pHand.appendChild(cardEl(c))); dealer.forEach(c=>$dHand.appendChild(cardEl(c))); }
    function startBJ(){ deck=freshDeck(); player=[drawCard(), drawCard()]; dealer=[drawCard()]; $bjMsg.textContent='‚Äî'; $bjMsg.style.color=''; renderBJ(); }
    startBJ();

    document.getElementById('hit').addEventListener('click',()=>{
      player.push(drawCard()); renderBJ();
      if(total(player)>21){ $bjMsg.textContent='–ü–µ—Ä–µ–±–æ—Ä!'; $bjMsg.style.color='var(--lose)'; }
    });

    document.getElementById('stand').addEventListener('click', async ()=>{
      const cost=200; if(currentUser.balance<cost){ $bjMsg.textContent='–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'; $bjMsg.style.color='var(--lose)'; return; }
      currentUser.balance-=cost; updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
      while(total(dealer)<17){ dealer.push(drawCard()); } renderBJ();
      const pt=total(player), dt=total(dealer); const rig=Math.random();
      if((dt>21||pt>dt)&&rig<0.5){ $bjMsg.textContent='–ü–æ–±–µ–¥–∞! +400'; $bjMsg.style.color='var(--win)'; currentUser.balance+=400; }
      else if(pt===dt){ $bjMsg.textContent='–ù–∏—á—å—è (–≤–æ–∑–≤—Ä–∞—Ç 200)'; $bjMsg.style.color='var(--warn)'; currentUser.balance+=200; }
      else { $bjMsg.textContent='–ü—Ä–æ–∏–≥—Ä—ã—à'; $bjMsg.style.color='var(--lose)'; }
      updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
    });

    document.getElementById('bjReset').addEventListener('click', startBJ);

    /***********************
     * –†–£–õ–ï–¢–ö–ê (–∞–Ω–∏–º)
     ***********************/
    const order=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
    const colors={0:'green'}; const reds=new Set([32,19,21,25,34,27,36,30,23,5,16,1,14,9,18,7,12,3]); for(const n of order){ if(n!==0){ colors[n]= reds.has(n)?'red':'black'; }}
    const seg=360/order.length; const $wheel=document.getElementById('wheel'); const $roulMsg=document.getElementById('roulMsg'); const $pickColor=document.getElementById('pickColor'); const $pointer=document.getElementById('pointer');

    function spinTo(idx){
      const target=360-(idx*seg+seg/2);
      const turns=6+Math.floor(Math.random()*4);
      const rot=turns*360+target;
      $wheel.style.transition='transform 3.2s cubic-bezier(.18,.75,.2,1)';
      $wheel.style.transform=`rotate(${rot}deg)`;
    }

    document.getElementById('spinRoulette').addEventListener('click', async ()=>{
      const cost=150; if(currentUser.balance<cost){ $roulMsg.textContent='–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'; $roulMsg.style.color='var(--lose)'; return; }
      currentUser.balance-=cost; updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
      $roulMsg.textContent='–í—Ä–∞—â–µ–Ω–∏–µ‚Ä¶'; $roulMsg.style.color='#a9b6df';
      const winIdx=Math.floor(Math.random()*order.length); spinTo(winIdx);
      const winNum=order[winIdx]; const winCol=colors[winNum];
      setTimeout(async ()=>{
        $pointer.classList.add('pointer-tick'); setTimeout(()=> $pointer.classList.remove('pointer-tick'), 500);
        let win=0; if($pickColor.value===winCol){ win=300; }
        if(win){ currentUser.balance+=win; $roulMsg.textContent=`–í—ã–ø–∞–ª–æ ${winNum} (${winCol}). –í—ã–∏–≥—Ä—ã—à +${win}`; $roulMsg.style.color='var(--win)'; }
        else { $roulMsg.textContent=`–í—ã–ø–∞–ª–æ ${winNum} (${winCol}). –ü—Ä–æ–∏–≥—Ä—ã—à.`; $roulMsg.style.color='var(--lose)'; }
        updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
      }, 3300);
    });

    /***********************
     * –ú–ò–ù–´ (–∞–Ω–∏–º)
     ***********************/
    const gridSize = 5; const totalCells = gridSize*gridSize;
    const $minesGrid = document.getElementById('minesGrid'); const $minesMsg = document.getElementById('minesMsg'); const $minesBet = document.getElementById('minesBet'); const $minesCount = document.getElementById('minesCount'); const $minesStart = document.getElementById('minesStart'); const $minesCash = document.getElementById('minesCashout');
    let minesActive=false, revealed=0, minesSet=new Set(), clicked=new Set(), stake=0, mines=0, mult=1;

    function resetMinesUI(){
      $minesGrid.innerHTML=''; for(let i=0;i<totalCells;i++){ const cell=document.createElement('button'); cell.className='mine-cell'; cell.dataset.idx=i; cell.textContent='?'; cell.disabled=true; cell.addEventListener('click',()=>onMine(i,cell)); $minesGrid.appendChild(cell); }
      $minesMsg.textContent='‚Äî'; $minesCash.disabled=true;
    }
    resetMinesUI();

    function randomMines(count){ const set=new Set(); while(set.size<count){ set.add(Math.floor(Math.random()*totalCells)); } return set; }
    function stepMultiplier(){ const safeLeft=(totalCells-mines)-revealed; const cellsLeft=totalCells-revealed; const p=safeLeft/cellsLeft; const risk=1+(mines/totalCells)*3.5; return Math.pow(1/Math.max(0.05,p), risk)*0.97; }
    function payout(){ const total=Math.floor(stake*mult); return { total, profit: Math.max(0,total-stake) }; }

    async function startMines(){
      stake=Math.max(1,parseInt($minesBet.value||0,10)); mines=Math.max(1,Math.min(24,parseInt($minesCount.value||0,10)));
      if(currentUser.balance<stake){ $minesMsg.textContent='–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'; $minesMsg.style.color='var(--lose)'; return; }
      currentUser.balance-=stake; updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
      minesSet=randomMines(mines); minesActive=true; revealed=0; clicked.clear(); mult=1;
      [...$minesGrid.children].forEach(c=>{ c.disabled=false; c.classList.remove('revealed','boom'); c.textContent='?'; });
      $minesMsg.textContent='–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –û—Ç–∫—Ä—ã–≤–∞–π –∫–ª–µ—Ç–∫–∏. √ó —Ä–∞—Å—Ç—ë—Ç –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ.'; $minesMsg.style.color='#a9b6df'; $minesCash.disabled=true;
    }
    function onMine(idx, el){
      if(!minesActive || clicked.has(idx)) return; clicked.add(idx);
      if(minesSet.has(idx)){ el.classList.add('boom'); el.textContent='üí£'; revealMines(); $minesMsg.textContent='üí• –ú–∏–Ω–∞! –°—Ç–∞–≤–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞.'; $minesMsg.style.color='var(--lose)'; minesActive=false; $minesCash.disabled=true; disableGrid(); return; }
      revealed++; mult*=stepMultiplier(); el.classList.add('revealed'); el.textContent='üíé'; const {total,profit}=payout(); $minesMsg.textContent=`–ë–µ–∑–æ–ø–∞—Å–Ω–æ! √ó${mult.toFixed(3)} | –ü—Ä–æ—Ñ–∏—Ç —Å–µ–π—á–∞—Å: +${profit}`; $minesMsg.style.color='var(--win)'; $minesCash.disabled=false;
      if(revealed >= (totalCells-mines)){ cashout(true); }
    }
    function revealMines(){ [...$minesGrid.children].forEach((c,i)=>{ if(minesSet.has(i)){ c.classList.add('boom'); c.textContent='üí£'; } }); }
    function disableGrid(){ [...$minesGrid.children].forEach(c=> c.disabled=true ); }
    async function cashout(auto=false){
      if(!minesActive || revealed===0) return; const {profit,total}=payout(); currentUser.balance+=profit; updateBalanceUI(); await apiSave(currentUser.name,currentUser.balance);
      $minesMsg.textContent=(auto?'–í—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã! ':'')+`–ó–∞–±—Ä–∞–ª +${profit}. –ò—Ç–æ–≥: ${total}.`; $minesMsg.style.color='var(--win)'; minesActive=false; $minesCash.disabled=true; disableGrid();
    }
    $minesStart.addEventListener('click', startMines); $minesCash.addEventListener('click', ()=>cashout(false));
  </script>
</body>
</html>
