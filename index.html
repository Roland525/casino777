<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lucky Box Casino</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- AUTH -->
  <div id="authPanel" class="card auth">
    <h1 class="logo">Lucky Box Casino</h1>
    <p class="note">–í—Ö–æ–¥ –ø–æ –Ω–∏–∫—É. –ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ (MockAPI —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä).</p>
    <input id="nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="24" />
    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg" class="msg">‚Äî</p>
  </div>

  <!-- CASINO -->
  <div id="casino" class="container hidden">
    <header class="topbar">
      <div class="brand">üé≤ Lucky Box</div>
      <div class="pill">–ü—Ä–∏–≤–µ—Ç, <b id="userDisplay">‚Äî</b>! –ë–∞–ª–∞–Ω—Å: <b id="balance">0</b> üí∞</div>
      <button class="btn danger" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="tab-slots">üé∞ –°–ª–æ—Ç—ã</button>
      <button class="tab-btn" data-tab="tab-bj">üÉè –ë–ª—ç–∫–¥–∂–µ–∫</button>
      <button class="tab-btn" data-tab="tab-roulette">üé° –†—É–ª–µ—Ç–∫–∞</button>
      <button class="tab-btn" data-tab="tab-mines">üí£ –ú–∏–Ω—ã</button>
      <button class="tab-btn" data-tab="tab-crash">üöÄ Crash</button>
    </nav>

    <!-- –°–õ–û–¢–´ -->
    <section id="tab-slots" class="card">
      <h2>–°–ª–æ—Ç—ã</h2>
      <div class="slot-wrap">
        <div class="reels" id="reels"></div>
        <div class="controls">
          <button class="btn" id="spin">–ö—Ä—É—Ç–∏—Ç—å (-100)</button>
          <p id="slotMsg" class="msg">‚Äî</p>
        </div>
      </div>
    </section>

    <!-- –ë–õ–≠–ö–î–ñ–ï–ö -->
    <section id="tab-bj" class="card hidden">
      <h2>–ë–ª—ç–∫–¥–∂–µ–∫</h2>
      <div class="table">
        <div class="msg faint">–°—Ç–∞–≤–∫–∞: 200</div>
        <div class="hands">
          <div>
            <h3>–ò–≥—Ä–æ–∫</h3>
            <div class="hand" id="playerHand"></div>
          </div>
          <div>
            <h3>–î–∏–ª–µ—Ä</h3>
            <div class="hand" id="dealerHand"></div>
          </div>
        </div>
        <div class="bj-ctrls">
          <button class="btn" id="bjStart">–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ (-200)</button>
          <button class="btn" id="hit" disabled>–í–∑—è—Ç—å</button>
          <button class="btn" id="stand" disabled>–•–≤–∞—Ç–∏—Ç</button>
        </div>
        <div id="bjMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –†–£–õ–ï–¢–ö–ê -->
    <section id="tab-roulette" class="card hidden">
      <h2>–†—É–ª–µ—Ç–∫–∞</h2>
      <div class="roulette">
        <div class="wheel-area">
          <div class="pointer" id="pointer"></div>
          <div class="wheel" id="wheel"><div class="face"></div></div>
        </div>
        <div class="row">
          <label class="pill">–°—Ç–∞–≤–∫–∞ –Ω–∞ —Ü–≤–µ—Ç:
            <select id="pickColor">
              <option value="red">–∫—Ä–∞—Å–Ω–æ–µ</option>
              <option value="black">—á—ë—Ä–Ω–æ–µ</option>
              <option value="green">–∑–µ—Ä–æ</option>
            </select>
          </label>
          <button class="btn" id="spinRoulette">–í—Ä–∞—â–∞—Ç—å (-150)</button>
        </div>
        <div id="roulMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –ú–ò–ù–´ -->
    <section id="tab-mines" class="card hidden">
      <h2>–ú–∏–Ω—ã</h2>
      <div class="mines-wrap">
        <div class="row wrap">
          <label class="pill">–°—Ç–∞–≤–∫–∞:
            <input id="minesBet" type="number" min="1" value="100" />
          </label>
          <label class="pill">–ú–∏–Ω:
            <input id="minesCount" type="number" min="1" max="24" value="5" />
          </label>
          <button class="btn" id="minesStart">–ù–∞—á–∞—Ç—å</button>
          <button class="btn" id="minesCashout" disabled>–ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à</button>
        </div>
        <div class="mines-grid" id="minesGrid"></div>
        <div id="minesMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- CRASH -->
    <section id="tab-crash" class="card hidden">
      <h2>üöÄ Crash</h2>
      <div class="crash-wrap">
        <div class="row wrap">
          <label class="pill">–°—Ç–∞–≤–∫–∞:
            <input id="crashBet" type="number" min="10" value="100" />
          </label>
          <button class="btn" id="crashStart">–°—Ç–∞—Ä—Ç</button>
          <button class="btn" id="crashCashout" disabled>–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
        <div class="crash-display">
          <h1 id="crashMult">√ó1.00</h1>
          <div id="crashStatus" class="msg">‚Äî</div>
        </div>
      </div>
    </section>
  </div>

  <script>
  "use strict";

  /* ====== API URL ====== */
  const API_URL = "https://casino777.onrender.com"; // –∞–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ Render-—Å–µ—Ä–≤–µ—Ä–∞

  /* ====== AUTH ====== */
  const $auth   = document.getElementById("authPanel");
  const $casino = document.getElementById("casino");
  const $authMsg = document.getElementById("authMsg");
  const $nick  = document.getElementById("nickname");
  const $user  = document.getElementById("userDisplay");
  const $bal   = document.getElementById("balance");

  let currentUser = null;

  const toInt = (x, d = 0) => Number.isFinite(+x) ? Math.trunc(+x) : d;

  function updateBalanceUI() {
    $bal.textContent = toInt(currentUser?.balance, 0);
    $bal.parentElement.classList.add("shine");
    setTimeout(() => $bal.parentElement.classList.remove("shine"), 600);
  }

  function openCasino() {
    $auth.classList.add("hidden");
    $casino.classList.remove("hidden");
    $user.textContent = currentUser.name;
    updateBalanceUI();
  }

  // ====== SAVE BALANCE —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä ======
  async function saveBalance() {
    if (!currentUser?.id) return;

    try {
      await fetch(`${API_URL}/api/saveBalance`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: currentUser.id,
          balance: currentUser.balance
        })
      });
    } catch (e) {
      console.warn("saveBalance error", e);
    }
  }

  // ====== LOGIN ======
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const nick = $nick.value.trim();
    if (!nick) {
      $authMsg.textContent = "–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫";
      return;
    }

    $authMsg.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶";

    try {
      let res = await fetch(`${API_URL}/api/findUser`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: nick })
      });
      const find = await res.json();
      let u = find.user;

      if (!u) {
        $authMsg.textContent = "–°–æ–∑–¥–∞—ë–º –∞–∫–∫–∞—É–Ω—Ç‚Ä¶";
        const r = await fetch(`${API_URL}/api/createUser`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: nick })
        });
        const data = await r.json();
        u = data.user;
        if (!u) {
          $authMsg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
          return;
        }
      }

      currentUser = { id: u.id, name: u.name, balance: toInt(u.balance, 1000) };
      localStorage.setItem("nick", u.name);
      $authMsg.textContent = "–ì–æ—Ç–æ–≤–æ!";
      openCasino();
    } catch (e) {
      console.error(e);
      $authMsg.textContent = "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
    }
  });

  // ====== Auto-login –ø–æ –Ω–∏–∫—É ======
  (async () => {
    const savedNick = localStorage.getItem("nick");
    if (!savedNick) return;
    try {
      const res = await fetch(`${API_URL}/api/findUser`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: savedNick })
      });
      const data = await res.json();
      if (data.user) {
        currentUser = {
          id: data.user.id,
          name: data.user.name,
          balance: toInt(data.user.balance, 1000)
        };
        openCasino();
      } else {
        localStorage.removeItem("nick");
      }
    } catch (e) {
      console.warn("auto-login failed", e);
    }
  })();

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("nick");
    location.reload();
  });

  /* ====== TABS ====== */
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll("section.card").forEach(s => s.classList.add("hidden"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.remove("hidden");
    });
  });

  /* ====== üé∞ –°–õ–û–¢–´ ====== */
  const symbols = ["üçí","üçã","‚≠ê","üîî","üçÄ","7Ô∏è‚É£","üíé","üçâ"];
  const $reels = document.getElementById("reels");
  const slotMsg = document.getElementById("slotMsg");

  function buildReel() {
    const reel = document.createElement("div");
    reel.className = "reel";
    const strip = document.createElement("div");
    strip.className = "strip";
    for (let i = 0; i < 30; i++) {
      const c = document.createElement("div");
      c.className = "cell";
      c.textContent = symbols[Math.floor(Math.random() * symbols.length)];
      strip.appendChild(c);
    }
    reel.appendChild(strip);
    return reel;
  }

  for (let i = 0; i < 5; i++) $reels.appendChild(buildReel());

  function spinReelTo(reel) {
    const strip = reel.firstChild;
    const cells = Array.from(strip.children);
    const cellH = 120;
    const targetY = -(Math.random() * cells.length * cellH);
    strip.style.transition = `transform 1s cubic-bezier(.2,.7,.2,1)`;
    strip.style.transform = `translateY(${targetY}px)`;
  }

  document.getElementById("spin").addEventListener("click", async () => {
    if (!currentUser) return;
    const COST = 100;
    if (currentUser.balance < COST) {
      slotMsg.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤";
      return;
    }

    currentUser.balance -= COST;
    updateBalanceUI();
    await saveBalance();

    Array.from($reels.children).forEach((r, i) =>
      setTimeout(() => spinReelTo(r), i * 100)
    );

    slotMsg.textContent = "–ö—Ä—É—Ç–∏–º‚Ä¶";

    setTimeout(async () => {
      const win = Math.random() < 0.2 ? 400 : 0;
      if (win > 0) {
        currentUser.balance += win;
        updateBalanceUI();
        await saveBalance();
      }
      slotMsg.textContent = win ? `üéâ –í—ã–∏–≥—Ä—ã—à +${win}` : "–ü—Ä–æ–∏–≥—Ä—ã—à";
    }, 1300);
  });

  /* ====== üÉè –ë–õ–≠–ö–î–ñ–ï–ö ====== */
  const $pHand  = document.getElementById("playerHand");
  const $dHand  = document.getElementById("dealerHand");
  const $bjMsg  = document.getElementById("bjMsg");
  const $bjStart= document.getElementById("bjStart");
  const $hit    = document.getElementById("hit");
  const $stand  = document.getElementById("stand");

  const SUITS = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

  const freshDeck = () => {
    const d = [];
    for (const s of SUITS) for (const r of RANKS) d.push(r + s);
    return d.sort(() => Math.random() - 0.5);
  };

  const cardVal = c => {
    const r = c.slice(0, -1);
    return r === "A" ? 11 : ["J","Q","K"].includes(r) ? 10 : +r;
  };

  const total = h => {
    let t = h.reduce((a, c) => a + cardVal(c), 0);
    let a = h.filter(c => c.startsWith("A")).length;
    while (t > 21 && a) { t -= 10; a--; }
    return t;
  };

  function renderBJ(p, d, hide = true) {
    $pHand.innerHTML = "";
    $dHand.innerHTML = "";
    p.forEach(c => { $pHand.innerHTML += `<div class='card-face'>${c}</div>`; });
    (hide ? [d[0], "üÇ†"] : d).forEach(c => {
      $dHand.innerHTML += `<div class='card-face'>${c}</div>`;
    });
  }

  let BJ = null;

  $bjStart.onclick = async () => {
    if (!currentUser) return;
    const BET = 200;
    if (currentUser.balance < BET) {
      $bjMsg.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤";
      return;
    }
    currentUser.balance -= BET;
    updateBalanceUI();
    await saveBalance();

    const deck = freshDeck();
    const player = [deck.pop(), deck.pop()];
    const dealer = [deck.pop(), deck.pop()];
    BJ = { deck, player, dealer, bet: BET, active: true };
    renderBJ(player, dealer, true);
    $hit.disabled = false;
    $stand.disabled = false;
    $bjMsg.textContent = "–í–∞—à —Ö–æ–¥";
  };

  $hit.onclick = () => {
    if (!BJ || !BJ.active) return;
    BJ.player.push(BJ.deck.pop());
    renderBJ(BJ.player, BJ.dealer, true);
    if (total(BJ.player) > 21) {
      BJ.active = false;
      $bjMsg.textContent = "–ü–µ—Ä–µ–±–æ—Ä! –ü—Ä–æ–∏–≥—Ä—ã—à.";
      $hit.disabled = $stand.disabled = true;
    }
  };

  $stand.onclick = async () => {
    if (!BJ || !BJ.active) return;
    while (total(BJ.dealer) < 17) BJ.dealer.push(BJ.deck.pop());
    renderBJ(BJ.player, BJ.dealer, false);

    const pt = total(BJ.player);
    const dt = total(BJ.dealer);
    let win = 0;
    if (pt <= 21 && (dt > 21 || pt > dt)) win = BJ.bet * 2;
    else if (pt === dt) win = BJ.bet;

    if (win > 0) {
      currentUser.balance += win;
      updateBalanceUI();
      await saveBalance();
    }
    $bjMsg.textContent = win ? `–ü–æ–±–µ–¥–∞ +${win - BJ.bet}` : "–ü—Ä–æ–∏–≥—Ä—ã—à";
    $hit.disabled = $stand.disabled = true;
    BJ.active = false;
  };

  /* ====== üé° –†–£–õ–ï–¢–ö–ê ====== */
  const order = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
  const reds  = new Set([32,19,21,25,34,27,36,30,23,5,16,1,14,9,18,7,12,3]);
  const seg   = 360 / order.length;

  const $wheel     = document.getElementById("wheel");
  const $pointer   = document.getElementById("pointer");
  const $roulMsg   = document.getElementById("roulMsg");
  const $pickColor = document.getElementById("pickColor");

  document.getElementById("spinRoulette").onclick = async () => {
    if (!currentUser) return;
    const COST = 150;
    if (currentUser.balance < COST) {
      $roulMsg.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤";
      return;
    }

    currentUser.balance -= COST;
    updateBalanceUI();
    await saveBalance();

    const idx = Math.floor(Math.random() * order.length);
    const num = order[idx];
    const color = num === 0 ? "green" : (reds.has(num) ? "red" : "black");
    const pick  = $pickColor.value;
    const win = (pick === color) ? (color === "green" ? 1500 : 300) : 0;

    $wheel.style.transition = "transform 3s ease-out";
    $wheel.style.transform  = `rotate(${360 - (idx * seg)}deg)`;
    $roulMsg.textContent = "–ö—Ä—É—Ç–∏–º‚Ä¶";

    setTimeout(async () => {
      if (win > 0) {
        currentUser.balance += win;
        updateBalanceUI();
        await saveBalance();
      }
      $roulMsg.textContent = `–í—ã–ø–∞–ª–æ ${num} (${color}). ${win ? "–í—ã–∏–≥—Ä—ã—à +" + win : "–ü—Ä–æ–∏–≥—Ä—ã—à"}`;
    }, 3200);
  };

  /* ====== üí£ –ú–ò–ù–´ ====== */
  const $grid = document.getElementById("minesGrid");
  const $mMsg = document.getElementById("minesMsg");
  const $bet  = document.getElementById("minesBet");
  const $count= document.getElementById("minesCount");
  const $mStart = document.getElementById("minesStart");
  const $cash   = document.getElementById("minesCashout");

  const GRID = 25;
  let mines = new Set();
  let opened = new Set();
  let mActive = false;
  let bet = 0;

  function resetGrid() {
    $grid.innerHTML = "";
    for (let i = 0; i < GRID; i++) {
      const c = document.createElement("button");
      c.className = "mine-cell";
      c.textContent = "?";
      c.onclick = () => reveal(i, c);
      $grid.appendChild(c);
    }
  }
  resetGrid();

  function genMines(n) {
    const s = new Set();
    while (s.size < n) s.add(Math.floor(Math.random() * GRID));
    return s;
  }

  $mStart.onclick = async () => {
    if (!currentUser) return;
    bet = +$bet.value;
    const n = Math.min(24, +$count.value);
    if (currentUser.balance < bet) {
      $mMsg.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤";
      return;
    }
    currentUser.balance -= bet;
    updateBalanceUI();
    await saveBalance();

    mines = genMines(n);
    opened.clear();
    mActive = true;
    $cash.disabled = true;
    $mMsg.textContent = "–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!";
    resetGrid();
  };

  function reveal(i, el) {
    if (!mActive || opened.has(i)) return;
    if (mines.has(i)) {
      el.textContent = "üí£";
      $mMsg.textContent = "–ú–∏–Ω–∞! –°—Ç–∞–≤–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞.";
      mActive = false;
      document.querySelectorAll(".mine-cell").forEach((b, j) => {
        if (mines.has(j)) b.textContent = "üí£";
        b.disabled = true;
      });
      return;
    }
    el.textContent = "üíé";
    opened.add(i);
    $cash.disabled = false;
    const profit = bet + opened.size * bet * 0.2;
    $mMsg.textContent = `–ü—Ä–æ—Ñ–∏—Ç: +${Math.round(profit - bet)}`;
  }

  $cash.onclick = async () => {
    if (!mActive) return;
    mActive = false;
    const profit = bet + opened.size * bet * 0.2;
    const gain = Math.round(profit);
    currentUser.balance += gain;
    updateBalanceUI();
    await saveBalance();
    $mMsg.textContent = "–ó–∞–±—Ä–∞–ª " + Math.round(profit - bet);
    document.querySelectorAll(".mine-cell").forEach(b => b.disabled = true);
    $cash.disabled = true;
  };

  /* ====== üöÄ CRASH ====== */
  const $crashBet    = document.getElementById("crashBet");
  const $crashStart  = document.getElementById("crashStart");
  const $crashCash   = document.getElementById("crashCashout");
  const $crashMult   = document.getElementById("crashMult");
  const $crashStatus = document.getElementById("crashStatus");

  let crashActive = false;
  let crashMultVal = 1;
  let crashTimer = null;
  let crashPoint = 0;

  function randPoint() {
    return (Math.random() ** 2.2) * 10 + 1.05;
  }

  $crashStart.onclick = async () => {
    if (!currentUser) return;
    const betC = +$crashBet.value;
    if (currentUser.balance < betC) {
      $crashStatus.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤";
      return;
    }
    currentUser.balance -= betC;
    updateBalanceUI();
    await saveBalance();

    crashActive = true;
    crashMultVal = 1;
    crashPoint = randPoint();
    $crashStart.disabled = true;
    $crashCash.disabled = false;
    $crashStatus.textContent = "üöÄ –ü–æ–ª—ë—Ç!";

    if (crashTimer) clearInterval(crashTimer);
    crashTimer = setInterval(() => {
      if (!crashActive) return;
      crashMultVal = +(crashMultVal * 1.015).toFixed(2);
      $crashMult.textContent = `√ó${crashMultVal.toFixed(2)}`;
      if (crashMultVal >= crashPoint) {
        clearInterval(crashTimer);
        crashActive = false;
        $crashCash.disabled = true;
        $crashStart.disabled = false;
        $crashMult.textContent = "üí• –ö–†–ê–®";
        $crashStatus.textContent = `–ü—Ä–æ–∏–≥—Ä—ã—à √ó${crashPoint.toFixed(2)}`;
      }
    }, 150);
  };

  $crashCash.onclick = async () => {
    if (!crashActive) return;
    clearInterval(crashTimer);
    crashActive = false;
    const betC = +$crashBet.value;
    const win = Math.floor(betC * crashMultVal);
    currentUser.balance += win;
    updateBalanceUI();
    await saveBalance();
    $crashCash.disabled = true;
    $crashStart.disabled = false;
    $crashStatus.textContent = `‚úÖ –ó–∞–±—Ä–∞–ª √ó${crashMultVal.toFixed(2)} = +${win}`;
  };
  </script>
</body>
</html>
