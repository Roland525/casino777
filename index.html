<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lucky Box Casino</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- AUTH -->
  <div id="authPanel" class="card auth">
    <h1 class="logo">Lucky Box Casino</h1>
    <p class="note">–í—Ö–æ–¥ –ø–æ –Ω–∏–∫—É. –ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ (MockAPI).</p>
    <input id="nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="24" />
    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg" class="msg">‚Äî</p>
  </div>

  <!-- CASINO -->
  <div id="casino" class="container hidden">
    <header class="topbar">
      <div class="brand">üé≤ Lucky Box</div>
      <div class="pill">–ü—Ä–∏–≤–µ—Ç, <b id="userDisplay">‚Äî</b>! –ë–∞–ª–∞–Ω—Å: <b id="balance">0</b> üí∞</div>
      <button class="btn danger" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="tab-slots">üé∞ –°–ª–æ—Ç—ã</button>
      <button class="tab-btn" data-tab="tab-bj">üÉè –ë–ª—ç–∫–¥–∂–µ–∫</button>
      <button class="tab-btn" data-tab="tab-roulette">üé° –†—É–ª–µ—Ç–∫–∞</button>
      <button class="tab-btn" data-tab="tab-mines">üí£ –ú–∏–Ω—ã</button>
    </nav>

    <!-- –°–õ–û–¢–´ -->
    <section id="tab-slots" class="card">
      <h2>–°–ª–æ—Ç—ã</h2>
      <div class="slot-wrap">
        <div class="reels" id="reels"></div>
        <div class="controls">
          <button class="btn" id="spin">–ö—Ä—É—Ç–∏—Ç—å (-100)</button>
          <p id="slotMsg" class="msg">‚Äî</p>
        </div>
      </div>
    </section>

    <!-- –ë–õ–≠–ö–î–ñ–ï–ö -->
    <section id="tab-bj" class="card hidden">
      <h2>–ë–ª—ç–∫–¥–∂–µ–∫</h2>
      <div class="table">
        <div class="msg faint">–°—Ç–∞–≤–∫–∞: 200. –¶–µ–ª—å ‚Äî –±–ª–∏–∂–µ –∫ 21, —á–µ–º –¥–∏–ª–µ—Ä.</div>
        <div class="hands">
          <div>
            <h3>–ò–≥—Ä–æ–∫</h3>
            <div class="hand" id="playerHand"></div>
          </div>
          <div>
            <h3>–î–∏–ª–µ—Ä</h3>
            <div class="hand" id="dealerHand"></div>
          </div>
        </div>
        <div class="bj-ctrls">
          <button class="btn" id="bjStart">–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ (-200)</button>
          <button class="btn" id="hit" disabled>–í–∑—è—Ç—å</button>
          <button class="btn" id="stand" disabled>–•–≤–∞—Ç–∏—Ç</button>
        </div>
        <div id="bjMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –†–£–õ–ï–¢–ö–ê -->
    <section id="tab-roulette" class="card hidden">
      <h2>–†—É–ª–µ—Ç–∫–∞</h2>
      <div class="roulette">
        <div class="wheel-area">
          <div class="pointer" id="pointer"></div>
          <div class="wheel" id="wheel"><div class="face"></div></div>
        </div>
        <div class="row">
          <label class="pill">–°—Ç–∞–≤–∫–∞ –Ω–∞ —Ü–≤–µ—Ç:
            <select id="pickColor">
              <option value="red">–∫—Ä–∞—Å–Ω–æ–µ</option>
              <option value="black">—á—ë—Ä–Ω–æ–µ</option>
              <option value="green">–∑–µ—Ä–æ</option>
            </select>
          </label>
          <button class="btn" id="spinRoulette">–í—Ä–∞—â–∞—Ç—å (-150)</button>
        </div>
        <div id="roulMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –ú–ò–ù–´ -->
    <section id="tab-mines" class="card hidden">
      <h2>–ú–∏–Ω—ã</h2>
      <div class="mines-wrap">
        <div class="row wrap">
          <label class="pill">–°—Ç–∞–≤–∫–∞:
            <input id="minesBet" type="number" min="1" value="100" />
          </label>
          <label class="pill">–ú–∏–Ω:
            <input id="minesCount" type="number" min="1" max="24" value="5" />
          </label>
          <button class="btn" id="minesStart">–ù–∞—á–∞—Ç—å</button>
          <button class="btn" id="minesCashout" disabled>–ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à</button>
        </div>
        <div class="mines-grid" id="minesGrid"></div>
        <div id="minesMsg" class="msg">‚Äî</div>
      </div>
    </section>
  </div>

  <script>
  "use strict";

  // ====== –ö–æ–Ω—Ñ–∏–≥ MockAPI (–ü–†–û–í–ï–†–¨, –ß–¢–û /users ‚Äî –¢–í–û–ô –†–ï–°–£–†–°!) ======
  const MOCK_URL = "https://69147b693746c71fe0486c2c.mockapi.io/users";

  // ====== –°–µ–ª–µ–∫—Ç–æ—Ä—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ======
  const $auth = document.getElementById("authPanel");
  const $casino = document.getElementById("casino");
  const $authMsg = document.getElementById("authMsg");
  const $nick = document.getElementById("nickname");
  const $user = document.getElementById("userDisplay");
  const $bal = document.getElementById("balance");
  let currentUser = null;

  // ====== –£—Ç–∏–ª–∏—Ç—ã ======
  function toInt(x, def=0){ const n = Number(x); return Number.isFinite(n)? n : def; }
  function updateBalanceUI(){
    $bal.textContent = toInt(currentUser?.balance, 0);
    $bal.parentElement.classList.add("shine");
    setTimeout(()=> $bal.parentElement.classList.remove("shine"), 600);
  }
  function openCasino(){
    $auth.classList.add("hidden");
    $casino.classList.remove("hidden");
    document.querySelector('[data-tab="tab-slots"]').click();
    $user.textContent = currentUser.name;
    updateBalanceUI();
  }

  async function req(url, opts={}){
    try{
      const r = await fetch(url, opts);
      // MockAPI –Ω–∞ –æ—à–∏–±–∫–∞—Ö –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ-JSON ‚Äî –ª–æ–≤–∏–º –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
      const text = await r.text();
      try { return { ok:r.ok, status:r.status, data: text ? JSON.parse(text) : null }; }
      catch { return { ok:r.ok, status:r.status, data: null }; }
    }catch(e){
      return { ok:false, status:0, data:null, error:e?.message||String(e) };
    }
  }

  // GET /users?name=... —Å fallback –Ω–∞ /users (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
  async function findUserByName(name){
    const q = await req(`${MOCK_URL}?name=${encodeURIComponent(name)}`);
    if (q.ok && Array.isArray(q.data)) return q.data[0] || null;

    // fallback (–µ—Å–ª–∏ –≤–Ω–µ–∑–∞–ø–Ω–æ 404/500)
    const all = await req(MOCK_URL);
    if (all.ok && Array.isArray(all.data)){
      return all.data.find(u => String(u?.name||"").trim() === String(name).trim()) || null;
    }
    return null;
  }

  async function createUser(name){
    const r = await req(MOCK_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ name, balance: 1000 })
    });
    return r.ok ? r.data : null;
  }

  async function saveBalance(){
    if(!currentUser?.id) return; // –∑–∞—â–∏—Ç–∞ –æ—Ç /users/undefined
    const body = { name: currentUser.name, balance: toInt(currentUser.balance,0) };
    await req(`${MOCK_URL}/${currentUser.id}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
  }

  // ====== –õ–æ–≥–∏–Ω / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ======
  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    const nick = $nick.value.trim();
    if(!nick){ $authMsg.textContent="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫"; return; }
    $authMsg.textContent="–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶";
    let u = await findUserByName(nick);
    if (!u){
      $authMsg.textContent="–°–æ–∑–¥–∞—ë–º –∞–∫–∫–∞—É–Ω—Ç‚Ä¶";
      u = await createUser(nick);
      if(!u){ $authMsg.textContent="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"; return; }
    }
    currentUser = { id: u.id, name: u.name, balance: toInt(u.balance,1000) };
    $authMsg.textContent="–ì–æ—Ç–æ–≤–æ!";
    openCasino();
  });

  document.getElementById("logoutBtn").addEventListener("click", ()=> location.reload());

  // ====== –¢–∞–±—ã ======
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll("section.card").forEach(s=>s.classList.add("hidden"));
      document.getElementById(btn.dataset.tab).classList.remove("hidden");
    });
  });

  // ====== –°–õ–û–¢–´ ======
  const symbols = ["üçí","üçã","‚≠ê","üîî","üçÄ","7Ô∏è‚É£","üíé","üçâ"];
  const $reels = document.getElementById("reels");
  const slotMsg = document.getElementById("slotMsg");

  function initSlotsUI(){
    $reels.innerHTML="";
    for(let i=0;i<5;i++){
      const reel=document.createElement("div");
      reel.className="reel";
      const strip=document.createElement("div");
      strip.className="strip";
      strip.style.top="-360px";
      for(let j=0;j<6;j++){
        const c=document.createElement("div");
        c.className="cell";
        c.textContent = symbols[Math.floor(Math.random()*symbols.length)];
        strip.appendChild(c);
      }
      reel.appendChild(strip);
      $reels.appendChild(reel);
    }
  }
  initSlotsUI();

  document.getElementById("spin").addEventListener("click", async ()=>{
    if(!currentUser) return;
    const COST = 100;
    if (currentUser.balance < COST){ slotMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }

    // RTP ~95%: 6% –Ω–∞ 800, ~16% –Ω–∞ 200
    const r = Math.random();
    let win = 0;
    if (r < 0.06) win = 800;
    else if (r < 0.22) win = 200;

    currentUser.balance = toInt(currentUser.balance - COST + win, 0);
    updateBalanceUI();
    await saveBalance();

    const reelsWrap=document.querySelector(".reels");
    reelsWrap.classList.add("shake"); setTimeout(()=>reelsWrap.classList.remove("shake"),900);
    slotMsg.textContent = win ? ("üéâ –í—ã–∏–≥—Ä—ã—à +" + win) : "–ü—Ä–æ–∏–≥—Ä—ã—à";
  });

  // ====== –ë–õ–≠–ö–î–ñ–ï–ö ======
  const SUITS=["‚ô†","‚ô•","‚ô¶","‚ô£"];
  const RANKS=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const $pHand=document.getElementById("playerHand");
  const $dHand=document.getElementById("dealerHand");
  const $bjMsg=document.getElementById("bjMsg");
  const $bjStart=document.getElementById("bjStart");
  const $hit=document.getElementById("hit");
  const $stand=document.getElementById("stand");
  let BJ = null; // {deck, player, dealer, bet, active}

  function freshDeck(){
    const d=[]; for(const s of SUITS) for(const r of RANKS) d.push(r+s);
    for(let i=d.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
    return d;
  }
  function cardVal(c){ const r=c.slice(0,-1); if(r==="A")return 11; if(["J","Q","K"].includes(r))return 10; return Number(r); }
  function total(hand){
    let t=hand.reduce((a,c)=>a+cardVal(c),0);
    let aces=hand.filter(c=>c.startsWith("A")).length;
    while(t>21 && aces){ t-=10; aces--; } return t;
  }
  function cardEl(card){
    if(card==="üÇ†"){
      const d=document.createElement("div"); d.className="card-face";
      d.style.background="#1b2442"; d.style.borderColor="rgba(255,255,255,.2)"; d.style.color="#1b2442";
      d.innerHTML='<div class="rank">?</div><div class="suit">?</div>'; return d;
    }
    const r=card.slice(0,-1), s=card.slice(-1);
    const d=document.createElement("div"); d.className="card-face"+((s==="‚ô•"||s==="‚ô¶")?" red":"");
    d.innerHTML='<div class="rank">'+r+'</div><div class="suit">'+s+'</div>'; return d;
  }
  function renderBJ(state){
    $pHand.innerHTML=""; $dHand.innerHTML="";
    state.player.forEach(c=>$pHand.appendChild(cardEl(c)));
    state.dealer.forEach(c=>$dHand.appendChild(cardEl(c)));
  }

  $bjStart.addEventListener("click", async ()=>{
    if(!currentUser) return;
    if(currentUser.balance < 200){ $bjMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }
    currentUser.balance -= 200; updateBalanceUI(); await saveBalance();
    const deck=freshDeck(); const player=[deck.pop(),deck.pop()]; const dealer=[deck.pop(),deck.pop()];
    BJ={deck,player,dealer,bet:200,active:true};
    renderBJ({player, dealer:[dealer[0],"üÇ†"]});
    $bjMsg.textContent="–í–∞—à —Ö–æ–¥"; $hit.disabled=false; $stand.disabled=false;
  });

  $hit.addEventListener("click", ()=>{
    if(!BJ?.active) return;
    BJ.player.push(BJ.deck.pop());
    renderBJ({ player:BJ.player, dealer:[BJ.dealer[0],"üÇ†"] });
    const pt=total(BJ.player);
    if(pt>21){ $bjMsg.textContent="–ü–µ—Ä–µ–±–æ—Ä!"; $hit.disabled=true; $stand.disabled=true; BJ.active=false; }
  });

  $stand.addEventListener("click", async ()=>{
    if(!BJ?.active) return;
    while(total(BJ.dealer) < 17) BJ.dealer.push(BJ.deck.pop());
    const pt=total(BJ.player), dt=total(BJ.dealer);
    renderBJ({ player:BJ.player, dealer:BJ.dealer });

    let win=0;
    if (pt<=21 && (dt>21 || pt>dt)) win=400;
    else if (pt===dt) win=200;

    if (win){ currentUser.balance = toInt(currentUser.balance + win, 0); updateBalanceUI(); await saveBalance(); }
    $bjMsg.textContent = win ? ("–ü–æ–±–µ–¥–∞! +" + (win-200)) : "–ü—Ä–æ–∏–≥—Ä—ã—à";
    $hit.disabled=true; $stand.disabled=true; BJ.active=false;
  });

  // ====== –†–£–õ–ï–¢–ö–ê ======
  const order=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
  const reds=new Set([32,19,21,25,34,27,36,30,23,5,16,1,14,9,18,7,12,3]);
  const seg=360/order.length;
  const $wheel=document.getElementById("wheel");
  const $roulMsg=document.getElementById("roulMsg");
  const $pickColor=document.getElementById("pickColor");
  const $pointer=document.getElementById("pointer");

  function spinTo(angle){
    const turns=6+Math.floor(Math.random()*4);
    const rot=turns*360+angle;
    $wheel.style.transition="transform 3.2s cubic-bezier(.18,.75,.2,1)";
    $wheel.style.transform="rotate("+rot+"deg)";
  }

  document.getElementById("spinRoulette").addEventListener("click", async ()=>{
    if(!currentUser) return;
    const COST=150;
    if (currentUser.balance < COST){ $roulMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }
    // "–ö—Ä—É—Ç–∏–º"
    const idx = Math.floor(Math.random()*order.length);
    const num = order[idx];
    const col = num===0 ? "green" : (reds.has(num) ? "red" : "black");
    const pick = $pickColor.value;
    let win = (pick===col) ? (col==="green" ? 1500 : 300) : 0;

    currentUser.balance = toInt(currentUser.balance - COST + win, 0);
    updateBalanceUI(); await saveBalance();

    spinTo(360-(idx*seg+seg/2));
    setTimeout(()=>{
      $pointer.classList.add("pointer-tick"); setTimeout(()=> $pointer.classList.remove("pointer-tick"), 500);
      $roulMsg.textContent = "–í—ã–ø–∞–ª–æ "+num+" ("+col+"). " + (win?("–í—ã–∏–≥—Ä—ã—à +"+win):"–ü—Ä–æ–∏–≥—Ä—ã—à.");
    }, 3300);
  });

  // ====== –ú–ò–ù–´ ======
  const GRID=25;
  const $minesGrid=document.getElementById("minesGrid");
  const $minesMsg=document.getElementById("minesMsg");
  const $minesBet=document.getElementById("minesBet");
  const $minesCount=document.getElementById("minesCount");
  const $minesStart=document.getElementById("minesStart");
  const $minesCash=document.getElementById("minesCashout");
  let mines=null, revealed=0, minesActive=false;

  function resetMinesUI(){
    $minesGrid.innerHTML="";
    for(let i=0;i<GRID;i++){
      const cell=document.createElement("button");
      cell.className="mine-cell"; cell.textContent="?"; cell.dataset.idx=i; cell.disabled=true;
      cell.addEventListener("click", ()=>reveal(i,cell));
      $minesGrid.appendChild(cell);
    }
    $minesMsg.textContent="‚Äî"; $minesCash.disabled=true;
  }
  resetMinesUI();

  function randomSet(count){
    const s=new Set(); while(s.size<count) s.add(Math.floor(Math.random()*GRID)); return s;
  }
  function revealAll(){
    Array.prototype.forEach.call($minesGrid.children,(c,i)=>{ c.disabled=true; if(mines.has(i)){ c.classList.add("boom"); c.textContent="üí£"; }});
  }
  function payout(){
    const bet = toInt($minesBet.value,100);
    // –ø—Ä–æ—Å—Ç–æ–π —Ä–æ—Å—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—è –Ω–∞ –∫–∞–∂–¥–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–º —à–∞–≥–µ
    const mult = 1 + revealed * (0.12 + toInt($minesCount.value,5)/100);
    const total = Math.floor(bet * mult);
    return { total, profit: total - bet };
  }

  $minesStart.addEventListener("click", async ()=>{
    if(!currentUser) return;
    const bet = toInt($minesBet.value,100);
    const count = Math.max(1, Math.min(24, toInt($minesCount.value,5)));
    if (currentUser.balance < bet){ $minesMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }
    currentUser.balance -= bet; updateBalanceUI(); await saveBalance();

    mines = randomSet(count); revealed=0; minesActive=true;
    Array.prototype.forEach.call($minesGrid.children, c=>{ c.disabled=false; c.classList.remove("revealed","boom"); c.textContent="?"; });
    $minesMsg.textContent="–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!"; $minesCash.disabled=true;
  });

  async function reveal(i, el){
    if(!minesActive) return;
    if (mines.has(i)){
      revealAll(); $minesMsg.textContent="üí• –ú–∏–Ω–∞!"; $minesCash.disabled=true; minesActive=false;
    }else{
      el.classList.add("revealed"); el.textContent="üíé"; el.disabled=true; revealed++;
      const pr = payout(); $minesMsg.textContent="–ë–µ–∑–æ–ø–∞—Å–Ω–æ! –ü—Ä–æ—Ñ–∏—Ç: +" + pr.profit; $minesCash.disabled=false;
      if (revealed >= (GRID - mines.size)){ // –≤—Å—ë –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–æ
        await cashout(true);
      }
    }
  }

  async function cashout(auto){
    if(!minesActive || revealed===0) return;
    const pr = payout();
    currentUser.balance += pr.total; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–≤–∫—É + –ø—Ä–æ—Ñ–∏—Ç, —Ç.–∫. —Å—Ç–∞–≤–∫—É —É–∂–µ —Å–ø–∏—Å–∞–ª–∏
    updateBalanceUI(); await saveBalance();
    $minesMsg.textContent=(auto?"–í—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã! ":"")+"–ó–∞–±—Ä–∞–ª +" + pr.profit + ". –ò—Ç–æ–≥: " + pr.total + "."; 
    minesActive=false; $minesCash.disabled=true;
    Array.prototype.forEach.call($minesGrid.children, c=> c.disabled=true);
  }
  $minesCash.addEventListener("click", ()=> cashout(false));
  </script>
</body>
</html>
