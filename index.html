<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lucky Box Casino</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- AUTH -->
  <div id="authPanel" class="card auth">
    <h1 class="logo">Lucky Box Casino</h1>
    <p class="note">–í—Ö–æ–¥ –ø–æ –Ω–∏–∫—É. –ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ (MockAPI).</p>
    <input id="nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="24" />
    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg" class="msg">‚Äî</p>
  </div>

  <!-- CASINO -->
  <div id="casino" class="container hidden">
    <header class="topbar">
      <div class="brand">üé≤ Lucky Box</div>
      <div class="pill">–ü—Ä–∏–≤–µ—Ç, <b id="userDisplay">‚Äî</b>! –ë–∞–ª–∞–Ω—Å: <b id="balance">0</b> üí∞</div>
      <button class="btn danger" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="tab-slots">üé∞ –°–ª–æ—Ç—ã</button>
      <button class="tab-btn" data-tab="tab-bj">üÉè –ë–ª—ç–∫–¥–∂–µ–∫</button>
      <button class="tab-btn" data-tab="tab-roulette">üé° –†—É–ª–µ—Ç–∫–∞</button>
      <button class="tab-btn" data-tab="tab-mines">üí£ –ú–∏–Ω—ã</button>
      <button class="tab-btn" data-tab="tab-crash">üöÄ Crash</button>
    </nav>

    <!-- –°–õ–û–¢–´ -->
    <section id="tab-slots" class="card">
      <h2>–°–ª–æ—Ç—ã</h2>
      <div class="slot-wrap">
        <div class="reels" id="reels"></div>
        <div class="controls">
          <button class="btn" id="spin">–ö—Ä—É—Ç–∏—Ç—å (-100)</button>
          <p id="slotMsg" class="msg">‚Äî</p>
        </div>
      </div>
    </section>

    <!-- –ë–õ–≠–ö–î–ñ–ï–ö -->
    <section id="tab-bj" class="card hidden">
      <h2>–ë–ª—ç–∫–¥–∂–µ–∫</h2>
      <div class="table">
        <div class="msg faint">–°—Ç–∞–≤–∫–∞: 200</div>
        <div class="hands">
          <div>
            <h3>–ò–≥—Ä–æ–∫</h3>
            <div class="hand" id="playerHand"></div>
          </div>
          <div>
            <h3>–î–∏–ª–µ—Ä</h3>
            <div class="hand" id="dealerHand"></div>
          </div>
        </div>
        <div class="bj-ctrls">
          <button class="btn" id="bjStart">–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ (-200)</button>
          <button class="btn" id="hit" disabled>–í–∑—è—Ç—å</button>
          <button class="btn" id="stand" disabled>–•–≤–∞—Ç–∏—Ç</button>
        </div>
        <div id="bjMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –†–£–õ–ï–¢–ö–ê -->
    <section id="tab-roulette" class="card hidden">
      <h2>–†—É–ª–µ—Ç–∫–∞</h2>
      <div class="roulette">
        <div class="wheel-area">
          <div class="pointer" id="pointer"></div>
          <div class="wheel" id="wheel"><div class="face"></div></div>
        </div>
        <div class="row">
          <label class="pill">–°—Ç–∞–≤–∫–∞ –Ω–∞ —Ü–≤–µ—Ç:
            <select id="pickColor">
              <option value="red">–∫—Ä–∞—Å–Ω–æ–µ</option>
              <option value="black">—á—ë—Ä–Ω–æ–µ</option>
              <option value="green">–∑–µ—Ä–æ</option>
            </select>
          </label>
          <button class="btn" id="spinRoulette">–í—Ä–∞—â–∞—Ç—å (-150)</button>
        </div>
        <div id="roulMsg" class="msg">‚Äî</div>
      </div>
    </section>

    <!-- –ú–ò–ù–´ -->
    <section id="tab-mines" class="card hidden">
      <h2>–ú–∏–Ω—ã</h2>
      <div class="mines-wrap">
        <div class="row wrap">
          <label class="pill">–°—Ç–∞–≤–∫–∞:
            <input id="minesBet" type="number" min="1" value="100" />
          </label>
          <label class="pill">–ú–∏–Ω:
            <input id="minesCount" type="number" min="1" max="24" value="5" />
          </label>
          <button class="btn" id="minesStart">–ù–∞—á–∞—Ç—å</button>
          <button class="btn" id="minesCashout" disabled>–ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à</button>
        </div>
        <div class="mines-grid" id="minesGrid"></div>
        <div id="minesMsg" class="msg">‚Äî</div>
      </div>
    </section>
    
<!-- CRASH -->
<section id="tab-crash" class="card hidden">
  <h2>üöÄ Crash</h2>
  <div class="crash-wrap">
    <div class="row wrap">
      <label class="pill">–°—Ç–∞–≤–∫–∞:
        <input id="crashBet" type="number" min="10" value="100" />
      </label>
      <button class="btn" id="crashStart">–°—Ç–∞—Ä—Ç</button>
      <button class="btn" id="crashCashout" disabled>–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
    <div class="crash-display">
      <h1 id="crashMult">√ó1.00</h1>
      <div id="crashStatus" class="msg">‚Äî</div>
    </div>
  </div>
</section>
  </div>


  <script>
  "use strict";

  /* ====== MockAPI config ====== */
  const MOCK_URL = "https://69147b693746c71fe0486c2c.mockapi.io/users";

  /* ====== State & helpers ====== */
  const $auth = document.getElementById("authPanel");
  const $casino = document.getElementById("casino");
  const $authMsg = document.getElementById("authMsg");
  const $nick = document.getElementById("nickname");
  const $user = document.getElementById("userDisplay");
  const $bal = document.getElementById("balance");
  let currentUser = null;

  const toInt = (x, d=0) => {
    const n = Number(x);
    return Number.isFinite(n) ? Math.trunc(n) : d;
  };

  const req = async (url, opts={}) => {
    try{
      const r = await fetch(url, opts);
      const text = await r.text();
      let data = null; try{ data = text? JSON.parse(text): null; }catch{}
      return { ok:r.ok, status:r.status, data };
    }catch(e){
      return { ok:false, status:0, data:null, error: e?.message||String(e) };
    }
  };

  async function findUserByName(name){
    const q = await req(`${MOCK_URL}?name=${encodeURIComponent(name)}`);
    if (q.ok && Array.isArray(q.data)) return q.data[0] || null;
    const all = await req(MOCK_URL); // fallback
    if (all.ok && Array.isArray(all.data)){
      return all.data.find(u => String(u?.name||"").trim() === String(name).trim()) || null;
    }
    return null;
  }
  async function getUserById(id){ 
    const r = await req(`${MOCK_URL}/${id}`); 
    return r.ok ? r.data : null; 
  }
  async function createUser(name){
    const r = await req(MOCK_URL, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ name, balance: 1000 })
    });
    return r.ok ? r.data : null;
  }
  async function saveBalance(){
    if(!currentUser?.id) return;
    await req(`${MOCK_URL}/${currentUser.id}`, {
      method:"PUT", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ name: currentUser.name, balance: toInt(currentUser.balance,0) })
    });
  }

  function updateBalanceUI(){
    $bal.textContent = toInt(currentUser?.balance, 0);
    $bal.parentElement.classList.add("shine");
    setTimeout(()=> $bal.parentElement.classList.remove("shine"), 600);
  }
  function openCasino(){
    $auth.classList.add("hidden");
    $casino.classList.remove("hidden");
    document.querySelector('[data-tab="tab-slots"]').click();
    $user.textContent = currentUser.name;
    updateBalanceUI();
  }

  /* ====== Auth ====== */
  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    const nick = $nick.value.trim();
    if(!nick){ $authMsg.textContent="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫"; return; }
    $authMsg.textContent="–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶";
    let u = await findUserByName(nick);
    if (!u){
      $authMsg.textContent="–°–æ–∑–¥–∞—ë–º –∞–∫–∫–∞—É–Ω—Ç‚Ä¶";
      u = await createUser(nick);
      if(!u){ $authMsg.textContent="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"; return; }
    }
    currentUser = { id: u.id, name: u.name, balance: toInt(u.balance,1000) };
    localStorage.setItem("uid", u.id);
    $authMsg.textContent="–ì–æ—Ç–æ–≤–æ!";
    openCasino();
  });

  /* ====== Auto-login ====== */
  (async()=>{
    const uid = localStorage.getItem("uid");
    if(uid){
      const u = await getUserById(uid);
      if(u){
        currentUser = { id: u.id, name: u.name, balance: toInt(u.balance,1000) };
        openCasino();
      }
      else localStorage.removeItem("uid");
    }
  })();

  /* ====== Auto-sync ====== */
  setInterval(async()=>{
    if(!currentUser?.id) return;
    const u = await getUserById(currentUser.id);
    if(u && u.balance !== currentUser.balance){
      currentUser.balance = u.balance;
      updateBalanceUI();
    }
  }, 8000);

  /* ====== Logout ====== */
  document.getElementById("logoutBtn").addEventListener("click", ()=> {
    localStorage.removeItem("uid");
    location.reload();
  });

  /* ====== Tabs ====== */
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll("section.card").forEach(s=>s.classList.add("hidden"));
      document.getElementById(btn.dataset.tab).classList.remove("hidden");
    });
  });

  /* ====== SLOTS ====== */
  const symbols = ["üçí","üçã","‚≠ê","üîî","üçÄ","7Ô∏è‚É£","üíé","üçâ"];
  const $reels = document.getElementById("reels");
  const slotMsg = document.getElementById("slotMsg");
  const SPIN_TIME = 1000; // ms

  function buildReel(){
    const reel = document.createElement("div");
    reel.className = "reel";
    const strip = document.createElement("div");
    strip.className = "strip";
    // –¥–ª–∏–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ –∫—Ä—É—Ç–∏—Ç—å
    for(let i=0;i<30;i++){
      const c=document.createElement("div");
      c.className="cell";
      c.textContent = symbols[Math.floor(Math.random()*symbols.length)];
      strip.appendChild(c);
    }
    reel.appendChild(strip);
    return reel;
  }
  function initSlotsUI(){
    $reels.innerHTML="";
    for(let i=0;i<5;i++) $reels.appendChild(buildReel());
  }
  initSlotsUI();

  function spinReelTo(reel, symbol){
    // –Ω–∞–π–¥—ë–º –∏–Ω–¥–µ–∫—Å –±–ª–∏–∂–∞–π—à–µ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–∞ –≤ –Ω–∏–∂–Ω–∏—Ö 10 —è—á–µ–π–∫–∞—Ö, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—Ä–∞—Å–∏–≤–æ
    const strip = reel.firstChild;
    const cells = Array.from(strip.children);
    let targetIndex = -1;
    for (let i=cells.length-10;i<cells.length;i++){
      if (cells[i].textContent === symbol){ targetIndex = i; break; }
    }
    if (targetIndex === -1) targetIndex = cells.length - 1; // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –Ω–∞—à–ª–∏
    const cellH = 120; // –≤—ã—Å–æ—Ç–∞ .cell –≤ –¥–µ—Å–∫—Ç–æ–ø–µ; –Ω–∞ –º–æ–±–∏–ª–µ –Ω–∏–∂–µ, –Ω–æ transition –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–∫
    const targetY = -(targetIndex * cellH - 2*cellH); // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –Ω—É–∂–Ω–∞—è –æ–∫–∞–∑–∞–ª–∞—Å—å –≤–æ 2-–π —è—á–µ–π–∫–µ (—Ü–µ–Ω—Ç—Ä)
    strip.style.transition = `transform ${SPIN_TIME}ms cubic-bezier(.2,.7,.2,1)`;
    strip.style.transform = `translateY(${targetY}px)`;
  }

  document.getElementById("spin").addEventListener("click", async ()=>{
    if(!currentUser) return;
    const COST = 100;
    if (currentUser.balance < COST){ slotMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }

    // —Å—á–∏—Ç–∞–µ–º –≤—ã–∏–≥—Ä—ã—à (RTP –æ–∫–æ–ª–æ 95%)
    const r = Math.random();
    let win = 0;
    if (r < 0.06) win = 800;       // 6%
    else if (r < 0.22) win = 200;  // 16%
    const resultSymbols = [];
    for(let i=0;i<5;i++){
      // –ò—Ç–æ–≥–æ–≤—ã–π —Ä—è–¥: –µ—Å–ª–∏ –≤—ã–∏–≥—Ä—ã—à –∫—Ä—É–ø–Ω—ã–π ‚Äî –±–æ–ª—å—à–µ üíé/7Ô∏è‚É£, –∏–Ω–∞—á–µ —Ä–∞–Ω–¥–æ–º
      const pool = win>=800 ? ["üíé","7Ô∏è‚É£","üçÄ","‚≠ê"] : symbols;
      resultSymbols.push(pool[Math.floor(Math.random()*pool.length)]);
    }

    // –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫–∞–∂–¥–æ–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞ –∫ —Å–≤–æ–µ–º—É —Å–∏–º–≤–æ–ª—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    Array.from($reels.children).forEach((reel,i)=>{
      // –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –Ω–æ–≤—ã–º —Å–ø–∏–Ω–æ–º —Å–±—Ä–∞—Å—ã–≤–∞–µ–º transform
      const strip = reel.firstChild;
      strip.style.transition="none";
      strip.style.transform="translateY(0)";
      // –∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–º–µ—â–µ–Ω–∏–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–∏
      setTimeout(()=> spinReelTo(reel, resultSymbols[i]), i*120);
    });

    // –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ –Ω–∞ –≤—Ä–µ–º—è —Å–ø–∏–Ω–∞
    const btn = document.getElementById("spin");
    btn.disabled = true;
    slotMsg.textContent = "–ö—Ä—É—Ç–∏–º‚Ä¶";

    setTimeout(async ()=>{
      currentUser.balance = toInt(currentUser.balance - COST + win, 0);
      updateBalanceUI(); await saveBalance();
      slotMsg.textContent = win ? ("üéâ –í—ã–∏–≥—Ä—ã—à +" + win) : "–ü—Ä–æ–∏–≥—Ä—ã—à";
      btn.disabled = false;
    }, SPIN_TIME + 200);
  });

  /* ====== BLACKJACK ====== */
  const SUITS=["‚ô†","‚ô•","‚ô¶","‚ô£"];
  const RANKS=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const $pHand=document.getElementById("playerHand");
  const $dHand=document.getElementById("dealerHand");
  const $bjMsg=document.getElementById("bjMsg");
  const $bjStart=document.getElementById("bjStart");
  const $hit=document.getElementById("hit");
  const $stand=document.getElementById("stand");
  let BJ = null; // {deck, player, dealer, active}

  const freshDeck = ()=>{
    const d=[]; for(const s of SUITS) for(const r of RANKS) d.push(r+s);
    for(let i=d.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
    return d;
  };
  const cardVal = c => { const r=c.slice(0,-1); if(r==="A")return 11; if(["J","Q","K"].includes(r))return 10; return Number(r); };
  const total = hand => { let t=hand.reduce((a,c)=>a+cardVal(c),0), aces=hand.filter(c=>c.startsWith("A")).length; while(t>21&&aces){t-=10;aces--;} return t; };

  function cardEl(card){
    if(card==="üÇ†"){
      const d=document.createElement("div"); d.className="card-face";
      d.style.background="#1b2442"; d.style.borderColor="rgba(255,255,255,.2)"; d.style.color="#1b2442";
      d.innerHTML='<div class="rank">?</div><div class="suit">?</div>'; return d;
    }
    const r=card.slice(0,-1), s=card.slice(-1);
    const d=document.createElement("div"); d.className="card-face"+((s==="‚ô•"||s==="‚ô¶")?" red":"");
    d.innerHTML='<div class="rank">'+r+'</div><div class="suit">'+s+'</div>'; return d;
  }
  function renderBJ(player, dealer, hideHole=true){
    $pHand.innerHTML=""; $dHand.innerHTML="";
    player.forEach(c=> $pHand.appendChild(cardEl(c)));
    (hideHole? [dealer[0],"üÇ†"] : dealer).forEach(c=> $dHand.appendChild(cardEl(c)));
  }

  $bjStart.addEventListener("click", async ()=>{
    if(!currentUser) return;
    const BET=200;
    if (currentUser.balance < BET){ $bjMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }
    currentUser.balance -= BET; updateBalanceUI(); await saveBalance();

    const deck=freshDeck(), player=[deck.pop(),deck.pop()], dealer=[deck.pop(),deck.pop()];
    BJ={deck,player,dealer,bet:BET,active:true};
    renderBJ(player, dealer, true);
    $bjMsg.textContent="–í–∞—à —Ö–æ–¥"; $hit.disabled=false; $stand.disabled=false;
  });

  $hit.addEventListener("click", ()=>{
    if(!BJ?.active) return;
    BJ.player.push(BJ.deck.pop());
    renderBJ(BJ.player, BJ.dealer, true);
    const pt=total(BJ.player);
    if(pt>21){
      $bjMsg.textContent="–ü–µ—Ä–µ–±–æ—Ä! –ü—Ä–æ–∏–≥—Ä—ã—à.";
      $hit.disabled=true; $stand.disabled=true; BJ.active=false;
    }
  });

  $stand.addEventListener("click", async ()=>{
    if(!BJ?.active) return;
    while(total(BJ.dealer) < 17) BJ.dealer.push(BJ.deck.pop());
    const pt=total(BJ.player), dt=total(BJ.dealer);
    renderBJ(BJ.player, BJ.dealer, false);

    let win=0;
    if (pt<=21 && (dt>21 || pt>dt)) win = BJ.bet*2;   // 400
    else if (pt===dt) win = BJ.bet;                   // 200 (push)

    if (win){
      currentUser.balance = toInt(currentUser.balance + win, 0);
      updateBalanceUI(); await saveBalance();
    }
    $bjMsg.textContent = win ? ("–ü–æ–±–µ–¥–∞! +" + (win - BJ.bet)) : "–ü—Ä–æ–∏–≥—Ä—ã—à";
    $hit.disabled=true; $stand.disabled=true; BJ.active=false;
  });

  /* ====== ROULETTE ====== */
  const order=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
  const reds=new Set([32,19,21,25,34,27,36,30,23,5,16,1,14,9,18,7,12,3]);
  const seg=360/order.length;
  const $wheel=document.getElementById("wheel");
  const $roulMsg=document.getElementById("roulMsg");
  const $pickColor=document.getElementById("pickColor");
  const $spinRoulette=document.getElementById("spinRoulette");
  const $pointer=document.getElementById("pointer");

  function spinToAngle(angle){
    const turns=6+Math.floor(Math.random()*4);
    const rot=turns*360 + angle;
    $wheel.style.transition="transform 3.2s cubic-bezier(.18,.75,.2,1)";
    $wheel.style.transform="rotate("+rot+"deg)";
  }

  $spinRoulette.addEventListener("click", async ()=>{
    if(!currentUser) return;
    const COST=150;
    if (currentUser.balance < COST){ $roulMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }
    $spinRoulette.disabled = true;
    $roulMsg.textContent="–í—Ä–∞—â–µ–Ω–∏–µ‚Ä¶";

    const idx = Math.floor(Math.random()*order.length);
    const num = order[idx];
    const color = (num===0) ? "green" : (reds.has(num) ? "red" : "black");
    const pick = $pickColor.value;
    const win = (pick===color) ? (color==="green" ? 1500 : 300) : 0;

    spinToAngle(360-(idx*seg+seg/2));

    setTimeout(async ()=>{
      currentUser.balance = toInt(currentUser.balance - COST + win, 0);
      updateBalanceUI(); await saveBalance();
      $pointer.classList.add("pointer-tick"); setTimeout(()=> $pointer.classList.remove("pointer-tick"), 500);
      $roulMsg.textContent = "–í—ã–ø–∞–ª–æ "+num+" ("+color+"). " + (win?("–í—ã–∏–≥—Ä—ã—à +"+win):"–ü—Ä–æ–∏–≥—Ä—ã—à.");
      $spinRoulette.disabled = false;
    }, 3300);
  });

  /* ====== MINES ====== */
  const GRID=25;
  const $minesGrid=document.getElementById("minesGrid");
  const $minesMsg=document.getElementById("minesMsg");
  const $minesBet=document.getElementById("minesBet");
  const $minesCount=document.getElementById("minesCount");
  const $minesStart=document.getElementById("minesStart");
  const $minesCash=document.getElementById("minesCashout");
  let mines=null, opened=new Set(), active=false, startBet=0;

  function resetMinesUI(){
    $minesGrid.innerHTML="";
    for(let i=0;i<GRID;i++){
      const cell=document.createElement("button");
      cell.className="mine-cell"; cell.textContent="?"; cell.dataset.idx=i; cell.disabled=true;
      cell.addEventListener("click", ()=>onReveal(i, cell));
      $minesGrid.appendChild(cell);
    }
    $minesMsg.textContent="‚Äî"; $minesCash.disabled=true;
  }
  resetMinesUI();

  function randomSet(count){ const s=new Set(); while(s.size<count) s.add(Math.floor(Math.random()*GRID)); return s; }
  function enableGrid(v){ Array.from($minesGrid.children).forEach(c=> c.disabled=!v); }
  function showAllMines(){ Array.from($minesGrid.children).forEach((c,i)=>{ if(mines.has(i)){ c.classList.add("boom"); c.textContent="üí£"; } c.disabled=true; }); }

  function currentPayout(){
    // –ø—Ä–æ—Å—Ç–∞—è ‚Äú—á–µ—Å—Ç–Ω–∞—è‚Äù —Ñ–æ—Ä–º—É–ª–∞: –∫–∞–∂–¥–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–ª–µ—Ç–∫–∞ –ø–æ–≤—ã—à–∞–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å ~ –ø–æ –æ–±—Ä–∞—Ç–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å –º–∞—Ä–∂–æ–π
    const m = toInt($minesCount.value,5);
    const safeLeft = (GRID - m) - opened.size;
    const cellsLeft = GRID - opened.size;
    const pSafe = Math.max(0.01, safeLeft / Math.max(1, cellsLeft));
    const stepMult = Math.max(1.02, (1/pSafe)*0.95);
    const total = Math.floor(startBet * Math.pow(stepMult, opened.size));
    return { total, profit: total - startBet };
  }

  $minesStart.addEventListener("click", async ()=>{
    if(!currentUser) return;
    const bet = toInt($minesBet.value,100);
    const count = Math.max(1, Math.min(24, toInt($minesCount.value,5)));
    if (currentUser.balance < bet){ $minesMsg.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"; return; }
    currentUser.balance -= bet; updateBalanceUI(); await saveBalance();

    startBet = bet;
    mines = randomSet(count);
    opened.clear();
    active = true;
    enableGrid(true);
    Array.from($minesGrid.children).forEach(c=>{ c.classList.remove("revealed","boom"); c.textContent="?"; });
    $minesMsg.textContent="–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!"; $minesCash.disabled=true;
  });

  async function onReveal(i, el){
    if(!active) return;
    if (opened.has(i)) return;

    if (mines.has(i)){
      active = false;
      showAllMines();
      $minesMsg.textContent="üí• –ú–∏–Ω–∞! –°—Ç–∞–≤–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞.";
      $minesCash.disabled = true;
    } else {
      opened.add(i);
      el.classList.add("revealed"); el.textContent="üíé"; el.disabled=true;
      const { profit } = currentPayout();
      $minesMsg.textContent="–ë–µ–∑–æ–ø–∞—Å–Ω–æ! –ü—Ä–æ—Ñ–∏—Ç: +" + profit;
      $minesCash.disabled = false;

      if (opened.size >= (GRID - mines.size)){
        // –≤—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã ‚Äî –∞–≤—Ç–æ–∫—ç—à-–∞—É—Ç
        await cashout(true);
      }
    }
  }

  async function cashout(auto){
    if(!active || opened.size===0) return;
    const { total, profit } = currentPayout();
    currentUser.balance = toInt(currentUser.balance + total, 0);
    updateBalanceUI(); await saveBalance();
    active = false; enableGrid(false);
    $minesCash.disabled = true;
    $minesMsg.textContent = (auto?"–í—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã! ":"") + "–ó–∞–±—Ä–∞–ª +" + profit + ". –ò—Ç–æ–≥: " + total + ".";
  }
  $minesCash.addEventListener("click", ()=> cashout(false));
  /* ====== CRASH ====== */
const $crashBet=document.getElementById("crashBet");
const $crashStart=document.getElementById("crashStart");
const $crashCashout=document.getElementById("crashCashout");
const $crashMult=document.getElementById("crashMult");
const $crashStatus=document.getElementById("crashStatus");
let crashActive=false, crashTimer=null, crashMult=1.0, crashCrashPoint=0;

function randCrashPoint(){return (Math.random()**2.2)*10+1.05;}
function resetCrashUI(){
  crashActive=false;
  clearInterval(crashTimer);
  $crashMult.textContent="√ó1.00";
  $crashCashout.disabled=true;
  $crashStart.disabled=false;
}

$crashStart.addEventListener("click",async()=>{
  if(!currentUser)return;
  const bet=toInt($crashBet.value,100);
  if(currentUser.balance<bet){$crashStatus.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤";return;}
  currentUser.balance-=bet;await saveBalance();updateBalanceUI();
  crashActive=true;crashMult=1.0;crashCrashPoint=randCrashPoint();
  $crashStart.disabled=true;$crashCashout.disabled=false;
  $crashStatus.textContent="üöÄ –ü–æ–ª—ë—Ç –Ω–∞—á–∞–ª—Å—è!";

  crashTimer=setInterval(()=>{
    if(!crashActive)return;
    crashMult=+(crashMult*1.015).toFixed(2);
    $crashMult.textContent="√ó"+crashMult.toFixed(2);
    if(crashMult>=crashCrashPoint){
      clearInterval(crashTimer);crashActive=false;
      $crashCashout.disabled=true;$crashStart.disabled=false;
      $crashMult.textContent="üí• –ö–†–ê–®";
      $crashStatus.textContent="–ü—Ä–æ–∏–≥—Ä—ã—à √ó"+crashCrashPoint.toFixed(2);
    }
  },150);
});

$crashCashout.addEventListener("click",async()=>{
  if(!crashActive)return;
  crashActive=false;clearInterval(crashTimer);
  const bet=toInt($crashBet.value,100);
  const win=Math.floor(bet*crashMult);
  currentUser.balance+=win;
  await saveBalance();updateBalanceUI();
  $crashCashout.disabled=true;$crashStart.disabled=false;
  $crashStatus.textContent=`‚úÖ –ó–∞–±—Ä–∞–ª √ó${crashMult.toFixed(2)} = +${win}`;
});

  </script>
</body>
</html>
